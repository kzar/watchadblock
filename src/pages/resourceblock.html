<!--TODO
call localizePage()
perform i18n changes/translate() calls
clean up code; match 80chars/line rule
do not collect duplicate resources in adblock.js
Optional: display resources from subframes?
-->
<html>
  <head>
    <title>Block a resource</title>
    <link rel="stylesheet" type="text/css" href="../options/options.css" />
    <script src="../port.js" type="text/javascript"></script>
    <script src="../jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
    <script src="../jquery/jquery.tablesorter.min.js" type="text/javascript"></script>
    <script src="../functions.js" type="text/javascript"></script>
    <script src="../filtering/filteroptions.js" type="text/javascript"></script>
    <script src="../filtering/filtertypes.js" type="text/javascript"></script>
    <script src="../filtering/fifocache.js" type="text/javascript"></script>
    <script src="../filtering/filterset.js" type="text/javascript"></script>
    <script type="text/javascript">
      var domain = '';
      var resources = [];
      //temporary: resources to be loaded...
      //when this is done, move the two 'var ' lines to the other <script> tag
      var TEMP_ADD_RESOURCES = false;
      if (window.location.search) {
        if (window.location.search.indexOf('&') == -1)
          TEMP_ADD_RESOURCES = true;
      } else {
        domain = 'www.24vandaag.nl';
        TEMP_ADD_RESOURCES = true;
      }

      if (TEMP_ADD_RESOURCES && (1==2)) {//(1==2) simply disables this block of code
        resources["http://platform.twitter.com/widgets/images/tweet.png"] = {type: ElementTypes.image};
        resources["##hidingrule"] = {filter: '24vandaag.nl##hidingrule'};
        resources["http://s7.addthis.com/static/r07/widget22.png"] = {type: ElementTypes.image};
        resources["http://static.ak.fbcdn.net/rsrc.php/zh/r/Ch71Zv858xU.png"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/allepartijen.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/allepolitici.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/templates/pj_flexum_15/css/images/ui-bg_glass_65_ffffff_1x400.png"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/templates/pj_flexum_15/images/background.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/templates/pj_flexum_15/images/backgroundgrijs.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/templates/pj_flexum_15/images/backgroundgroen.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/templates/pj_flexum_15/images/backgroundopinie.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/templates/pj_flexum_15/images/ss_sf_left.png"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/templates/pj_flexum_15/images/ss_sf_right.png"] = {type: ElementTypes.image};
        resources["http://www.google.com/uds/modules/elements/newsshow/generic-noborder-298x248.gif"] = {type: ElementTypes.image};
        resources["http://a0.twimg.com/profile_images/104605408/wim_normal.jpg"] = {type: ElementTypes.image};
        resources["http://a0.twimg.com/profile_images/1084923492/7063aae7-1f96-4e5d-8862-c179376a4a4b_normal.jpg"] = {type: ElementTypes.image};
        resources["http://a0.twimg.com/profile_images/889186980/femkehaar_normal.jpg"] = {type: ElementTypes.image};
        resources["http://a0.twimg.com/profile_images/907841588/andre_twitter_normal.jpg"] = {type: ElementTypes.image};
        resources["http://a1.twimg.com/profile_images/1122994577/dsc3nr2_normal.JPG"] = {type: ElementTypes.image};
        resources["http://a2.twimg.com/profile_images/1020356798/Afbeelding_52_normal.png"] = {type: ElementTypes.image};
        resources["http://a2.twimg.com/profile_images/656335562/GL_ZIDT_badge_INTEGR_RGB_normal.png"] = {type: ElementTypes.image};
        resources["http://a2.twimg.com/profile_images/815362166/GW2_normal.jpg"] = {type: ElementTypes.image};
        resources["http://a2.twimg.com/profile_images/897943090/verkiezingsposter_2010_internet_normal.jpg"] = {type: ElementTypes.image};
        resources["http://a3.twimg.com/profile_images/894603035/twitterfoto_normal.jpg"] = {type: ElementTypes.image};
        resources["http://a3.twimg.com/profile_images/990474255/foto_2_normal.JPG"] = {type: ElementTypes.image};
        resources["http://i.ytimg.com/vi/5f5OHIocm3c/0.jpg"] = {type: ElementTypes.image};
        resources["http://i.ytimg.com/vi/90j0v3INyjo/0.jpg"] = {type: ElementTypes.image};
        resources["http://i.ytimg.com/vi/CE6qFPkqZb0/0.jpg"] = {type: ElementTypes.image};
        resources["http://i.ytimg.com/vi/F9up5Y4ZUPM/0.jpg"] = {type: ElementTypes.image};
        resources["http://i.ytimg.com/vi/ax8bNFF4Z1I/0.jpg"] = {type: ElementTypes.image};
        resources["http://i.ytimg.com/vi/e75yQd8ebVw/0.jpg"] = {type: ElementTypes.image};
        resources["http://i.ytimg.com/vi/usT1I9ggS9k/0.jpg"] = {type: ElementTypes.image};
        resources["http://i.ytimg.com/vi/zTkD10ekL3k/0.jpg"] = {type: ElementTypes.image};
        resources["http://l.addthiscdn.com/live/t00/250lo.gif?kd8xwl&uid=4cb0528c36b511ac&CXNID=2000001.5215456080540439072NXC&pub=svanrijsewijk&rev=82281&si=4cb0529e2fa64645&ln=nl&uf=0&pi=1&dp=www.24vandaag.nl&pc=tbx"] = {type: ElementTypes.image};
        resources["http://nt0.ggpht.com/news/tbn/iC8TEcLVB6kJ"] = {type: ElementTypes.image};
        resources["http://nt0.ggpht.com/news/tbn/uAkJ4azUgEQJ"] = {type: ElementTypes.image};
        resources["http://nt0.ggpht.com/news/tbn/xNGmlucT9HwJ"] = {type: ElementTypes.image};
        resources["http://nt1.ggpht.com/news/tbn/3evpXVYfUnMJ"] = {type: ElementTypes.image};
        resources["http://nt2.ggpht.com/news/tbn/UouA47y7RCkJ"] = {type: ElementTypes.image};
        resources["http://nt3.ggpht.com/news/tbn/gz5wLZ5OQegJ"] = {type: ElementTypes.image};
        resources["http://nt3.ggpht.com/news/tbn/l-yeHk-h6rkJ"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/elsevier.gif"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/home-fotos.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/home-laatstenieuws.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/home-politiekepartijen.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/home-twitter.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/home-videos.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/joop.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/logo.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/nd.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/nos.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/nu.gif"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/parlementenpolitiek.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/refdag.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/trouw.gif"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/images/twitterbanner.jpg"] = {type: ElementTypes.image};
        resources["http://www.24vandaag.nl/templates/pj_flexum_15/favicon.ico"] = {type: ElementTypes.image};
        resources["http://www.google-analytics.com/__utm.gif?utmwv=4.7.2&utmn=1049402725&utmhn=www.24vandaag.nl&utmcs=UTF-8&utmsr=1600x900&utmsc=24-bit&utmul=nl&utmje=1&utmfl=10.2%20d161&utmdt=24Vandaag%2C%20het%20laatste%20politieke%20nieuws&utmhid=213266367&utmr=-&utmp=%2F&utmac=UA-383680-8&utmcc=__utma%3D9291830.2009037066.1286623884.1286623884.1286623884.1%3B%2B__utmz%3D9291830.1286623884.1.1.utmcsr%3D(direct)%7Cutmccn%3D(direct)%7Cutmcmd%3D(none)%3B"] = {type: ElementTypes.image};
        resources["http://www.google.com/uds/css/youtube-logo-55x24.png"] = {type: ElementTypes.image};
        resources["http://www.google.com/uds/modules/elements/newsshow/cleardot.gif"] = {type: ElementTypes.image};
        resources["http://www.google.com/uds/modules/elements/newsshow/no-image-80x60.gif"] = {type: ElementTypes.image};
        resources["http://www.google.com/uds/stats?r0=hl%7Celements&nc=1286623917570_15350"] = {type: ElementTypes.image};
        resources["http://www.google.com/uds/stats?r0=hl%7Csearch&r1=hl%7Csearch&nc=1286623916861_15178"] = {type: ElementTypes.subdocument};
        resources["http://platform.twitter.com/widgets/tweet_button.html?url=http%3A%2F%2Fwww.24vandaag.nl%2F&count=horizontal&text=24Vandaag%2C%20het%20laatste%20politieke%20nieuws&via=AddThis"] = {type: ElementTypes.subdocument};
        resources["http://s7.addthis.com/static/r07/sh24.html#"] = {type: ElementTypes.subdocument};
        resources["http://www.facebook.com/plugins/like.php?href=http%3A%2F%2Fwww.24vandaag.nl%2F&layout=button_count&show_faces=false&width=100&action=like&font=arial&"] = {type: ElementTypes.subdocument};
        resources["http://www.google.com/uds/modules/elements/newsshow/iframe.html?topic=p&ned=nl_nl&rsz=large&hl=nl&format=300x250"] = {type: ElementTypes.script};
        resources["http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"] = {type: ElementTypes.script};
        resources["http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"] = {type: ElementTypes.script};
        resources["http://ajax.googleapis.com/ajax/services/search/news?key=internal-newsshow&v=1.0&source=uds-ns-300x250&topic=p&rsz=large&ned=nl_nl&hl=nl&callback=_callbacks_._0gf2enh6k"] = {type: ElementTypes.script};
        resources["http://api.twitter.com/1/24vandaag/lists/lijsttrekkers/statuses.json?per_page=8&callback=jsonp1286623901536&_=1286623902423"] = {type: ElementTypes.script};
        resources["http://api.twitter.com/1/24vandaag/lists/politici/statuses.json?per_page=8&callback=jsonp1286623901534&_=1286623902407"] = {type: ElementTypes.script};
        resources["http://api.twitter.com/1/24vandaag/lists/politieke-partijen/statuses.json?per_page=8&callback=jsonp1286623901535&_=1286623902413"] = {type: ElementTypes.script};
        resources["http://pagead2.googlesyndication.com/pagead/show_ads.js"] = {type: ElementTypes.script};
        resources["http://s7.addthis.com/js/250/addthis_widget.js"] = {type: ElementTypes.script};
        resources["http://static.ak.fbcdn.net/rsrc.php/z1/r/h0YSh5UKKFr.js"] = {type: ElementTypes.script};
        resources["http://static.ak.fbcdn.net/rsrc.php/zK/p/r/HWL11JhzW9w.js"] = {type: ElementTypes.script};
        resources["http://static.ak.fbcdn.net/rsrc.php/zl/p/r/yi2jboDEovM.js"] = {type: ElementTypes.script};
        resources["http://urls.api.twitter.com/1/urls/count.json?url=http%3A%2F%2Fwww.24vandaag.nl%2F&callback=twttr.receiveCount"] = {type: ElementTypes.script};
        resources["http://www.24vandaag.nl/templates/pj_flexum_15/css/jquery.min.js"] = {type: ElementTypes.script};
        resources["http://www.24vandaag.nl/templates/pj_flexum_15/css/jquery.tweet.js"] = {type: ElementTypes.script};
        resources["http://www.24vandaag.nl/templates/pj_flexum_15/css/twitter.js"] = {type: ElementTypes.script};
        resources["http://www.google-analytics.com/ga.js"] = {type: ElementTypes.script};
        resources["http://www.google.com/jsapi"] = {type: ElementTypes.script};
        resources["http://www.google.com/jsapi?key=ABQIAAAA1XbMiDxx_BTCY2_FkPh06RRaGTYH6UMl8mADNa0YKuWNNa8VNxQEerTAUcfkyrr6OwBovxn7TDAH5Q"] = {type: ElementTypes.script};
        resources["http://www.google.com/jsapi?key=internal-newsshow&autoload={modules:[{name:elements;version:1;packages:[newsshow];language:nl}]}"] = {type: ElementTypes.script};
        resources["http://www.google.com/uds/GvideoSearch?callback=google.search.VideoSearch.RawCompletion&context=0&lstkp=0&rsz=small&hl=nl&gss=.nl&sig=3e6df43077b5c81cfa8f106ec8536c5c&q=ytchannel%3ADemocraten66&key=notsupplied&v=1.0"] = {type: ElementTypes.script};
        resources["http://www.google.com/uds/GvideoSearch?callback=google.search.VideoSearch.RawCompletion&context=0&lstkp=0&rsz=small&hl=nl&gss=.nl&sig=3e6df43077b5c81cfa8f106ec8536c5c&q=ytchannel%3APVVep&key=notsupplied&v=1.0"] = {type: ElementTypes.script};
        resources["http://www.google.com/uds/api/elements/1.0/f93f17b91c8ceb6316a8fa51458d8a22/default,slideshow,newsshow+nl.I.js"] = {type: ElementTypes.script};
        resources["http://www.google.com/uds/api/search/1.0/3e6df43077b5c81cfa8f106ec8536c5c/default+nl.I.js"] = {type: ElementTypes.script};
        resources["http://www.google.com/uds/api?file=uds.js&v=1.0"] = {type: ElementTypes.script};
        resources["http://www.google.com/uds/api?file=uds.js&v=1.0&source=uds-vsw&key=ABQIAAAASZYRhigKwbnL3sllNH75nBQrTe3wsRoG6AcrvOOXYmjGvRPuBBRul0wzRFNGEY5LdFgpjfJvb8cNcg"] = {type: ElementTypes.script};
        resources["http://www.google.com/uds/solutions/slideshow/gfslideshow.js"] = {type: ElementTypes.script};
        resources["http://www.google.com/uds/solutions/videobar/gsvideobar.js"] = {type: ElementTypes.script};
        resources["http://www.google.com/uds/solutions/videosearch/gsvideosearch.js?mode=new"] = {type: ElementTypes.script};
        resources["http://s7.addthis.com/static/r07/widget45.css"] = {type: ElementTypes.script};
        resources["http://static.ak.fbcdn.net/rsrc.php/z5/r/Fm9hhBrLU3y.css"] = {type: ElementTypes.script};
        resources["http://www.24vandaag.nl/templates/pj_flexum_15/css/joomla.css"] = {type: ElementTypes.script};
        resources["http://www.24vandaag.nl/templates/pj_flexum_15/css/jquery.tweet.css"] = {type: ElementTypes.stylesheet};
        resources["http://www.24vandaag.nl/templates/pj_flexum_15/css/jquery.tweet.query.css"] = {type: ElementTypes.stylesheet};
        resources["http://www.24vandaag.nl/templates/pj_flexum_15/css/template_css.css"] = {type: ElementTypes.stylesheet};
        resources["http://www.google.com/uds/api/elements/1.0/f93f17b91c8ceb6316a8fa51458d8a22/newsshow.css"] = {type: ElementTypes.stylesheet};
        resources["http://www.google.com/uds/css/gsearch.css"] = {type: ElementTypes.stylesheet};
        resources["http://www.google.com/uds/solutions/videosearch/gsvideosearch.css"] = {type: ElementTypes.stylesheet};
        resources["http://www.google.com/uds/api/elements/1.0/f93f17b91c8ceb6316a8fa51458d8a22/newsshow.css"] = {type: ElementTypes.stylesheet};
        resources["http://www.google.com/uds/css/gsearch.css"] = {type: ElementTypes.stylesheet};
        resources["http://www.google.com/uds/solutions/videosearch/gsvideosearch.css"] = {type: ElementTypes.stylesheet};
      }
    </script>
    <style type="text/css">
      .icon {
        background-image:url('../img/icon32.png')
      }
      input:disabled + label {
        cursor:default;
      }
      #resourceslist {
        text-align: left;
        cursor: default;
        width: 100%;
        margin-bottom:10px;
      }
      .header {
        background-image: url(../img/sort.gif);	
        cursor: pointer;
        background-repeat: no-repeat;
        background-position: center left;
        padding-left: 20px;
      }
      .headerSortDown {
        background-image: url(../img/sortdesc.gif);	
      }
      .headerSortUp {
        background-image: url(../img/sortasc.gif);	
      }
      #resourceslist td, #selectblockableurl :not(#confirmUrl):not(b) {
        font-size: 12px;
        padding: 0px;
        padding-right: 5px;
      }
      #resourceslist tbody td:last-of-type:first-letter {
        visibility:hidden;
      }
      .blocked {
        color:red;
      }
      .whitelisted {
        color:green;
      }
      #legend {
        font-size: 12px;
        background-color: white;
        position:fixed;
        top: 25px;
        right: 10px;
        padding: 5px;
      }
      .hiding {
        color:blue;
      }
      .clickableRow {
        cursor: pointer;
      }
      #selectblockableurl input:radio {
        margin-right: 7px;
      }
      #filterpreview {
        font-size:12px;
        font-style:italic;
      }
      .onlyifdebug {
        display:none;
      }
      #addthefilter {
        font-weight:bold;
        font-size:15px;
      }
    </style>
    <script type="text/javascript">
      var domaindata;

      function generateTable() {
        //find matching filters
        var local_filterset = FilterSet.fromText(domaindata.filtertext, undefined, true);
        var _limited_to_domain = local_filterset.limitedToDomain(domain);
        delete domaindata;

        //Generate the table containing all resources
        function truncateI(j) {
          if (j.length > 90)
            if (j.indexOf('?') > 43 && j.indexOf('?') <= 85)
              j = j.substring(0, j.indexOf('?') + 1) + '[...]';
          if (j.length > 90)
            j = j.substring(0, 86) + '[...]';
          return j;
        }
        function getTypeName(type) {
          switch(type) {
            case undefined: return "hiding";
            case ElementTypes.script: return "script";
            case ElementTypes.image: return "image";
            case ElementTypes.background: return "image";
            case ElementTypes.stylesheet: return "style definition";
            case ElementTypes.object: return "interactive object";
            case ElementTypes.subdocument: return "frame";
            case ElementTypes.media: return "audio/video";
            default: return "unknown";
          }
        }
        var rows = [];
        for (var i in resources) {
          var matchingfilter = resources[i].filter;
          if (!matchingfilter)
            matchingfilter = _limited_to_domain.matches(i, resources[i].type, true);

          var type = {sort:3, name:undefined};
          if (matchingfilter)
            if (matchingfilter[0] == '@')
              type = {sort:2, name:'whitelisted'};
            else if (i[0] == '#')
              type = {sort:0, name:'hiding'};
            else
              type = {sort:1, name:'blocked'};

          var thisrow = "<tr" + (type.name ? ' class="' + type.name + '"' : '') + ">";
          var disabled = (type.name == 'whitelisted' || type.name == 'hiding');
          thisrow += "<td><input type='checkbox'" + (disabled ? ' disabled="disabled"' : '') + "/></td>";
          disabled = (disabled ? '' : ' class="clickableRow"');
          thisrow += "<td" + disabled + " title='" + i + "'>" + truncateI(i) + "</td>";
          thisrow += "<td" + disabled + " i18n='" + getTypeName(resources[i].type) + "'>" + getTypeName(resources[i].type) + "</td>";
          thisrow += "<td" + disabled + ">" + (type.name ? type.sort + matchingfilter : '3-') + "</td>";
          thisrow += "</tr>";
          rows.push(thisrow);
        }
        $("#loading").remove();
        $("#resourceslist tbody").append(rows.join(''));
      };

      //Generate a list of pre-defined url filters
      function generateFilterSuggestions() {
        var url = $(".selected td:nth-of-type(2)").attr('title');
        url = url.replace(/\W{5}\(.*\)$/, '').replace(/\#.*$/, '');
        var isBlocked = ($(".selected").hasClass("blocked"));
        var blocksuggestions = [];
        var strippedUrl = url.replace(/^[a-z]{0,5}\:\/\/(www\.)?/, '');
        blocksuggestions.push(strippedUrl);
        if (strippedUrl.indexOf("?") > 0 || strippedUrl.indexOf("#") > 0) {
          strippedUrl = strippedUrl.replace(/(\?|\#).*/, '');
          blocksuggestions.push(strippedUrl);
        }
        if (strippedUrl.indexOf("/") > 0 && 
            strippedUrl.lastIndexOf('/') != strippedUrl.indexOf('/')) {
          strippedUrl = strippedUrl.substr(0, strippedUrl.lastIndexOf('/') + 1);
          blocksuggestions.push(strippedUrl);
        }
        if (strippedUrl.indexOf('/') > 0) {
          strippedUrl = strippedUrl.substr(0, strippedUrl.indexOf('/'));
          blocksuggestions.push(strippedUrl);
        }
        if (strippedUrl.indexOf('.') != strippedUrl.lastIndexOf('.')) {
          if (strippedUrl.replace('.co.', '').indexOf('.') != -1) {
            strippedUrl = strippedUrl.match(/[^.]+\.(co\.)?[^.]+$/i)[0];
            blocksuggestions.push(strippedUrl);
          }
        }

        var suggestions = [];
        for (var i in blocksuggestions) {
          suggestions.push("<input type='radio' name='urloption' id='suggest_" + i + "' value='" +
              (isBlocked ? '@@||' : '||') + blocksuggestions[i] + "'/>" +
              "<label for='suggest_" + i + "'> " + blocksuggestions[i] + "</label><br/>");
        }
        $("#suggestions").html(suggestions.join(''));
        if ($("#suggestions").find('input:first-child').val().indexOf('?') > 0)
          $($("#suggestions").children('input')[1]).attr('checked', 'checked');
        else
          $("#suggestions").find('input:first-child').attr('checked', 'checked');
        
        if (!isBlocked)
          $("#selectblockableurl b").text("Block every resource containing:");
        else
          $("#selectblockableurl b").text("Whitelist every resource containing:");
        $("#custom + label").
          html("Custom: <input type='text' id='customurl' value='" + url + 
          "' size='99' title='Note: you can use * as wildcard here'/>");
      }

      //Create the filter that will be applied
      function createfilter() {
        var isBlocked = ($(".selected").hasClass("blocked"));
        var urlfilter = '';
        if ($('#selectblockableurl #customurl').length != 0)
          urlfilter = (isBlocked ? '@@' : '') + $('#customurl').val();
        else
          urlfilter = $('#selectblockableurl input').val();
        if ((/^(\@\@)?\/.*\/$/).test(urlfilter))
          urlfilter += '*';

        var options = [];
        $("#chooseoptions > input:checked, #types > input:not(:checked)").each(function() {
          if ($(this).val())
            options.push($(this).val());
        });

        return urlfilter + ((options.length != 0) ? '$' + options.join(',') : '');
      }

      function CheckThirdParty(domain1, domain2) {
        var match1 = domain1.match(/[^.]+\.(co\.)?[^.]+$/) || [ domain1 ];
        var match2 = domain2.match(/[^.]+\.(co\.)?[^.]+$/) || [ domain2 ];
        return (match1[0].toLowerCase() != match2[0].toLowerCase());
      }
      function GetThirdPartyDomain(domain) {
        var match = domain.match(/[^.]+\.(co\.)?[^.]+$/) || [ domain ];
        return match[0].toLowerCase();
      }

      function isValidDomainList(text) {
        var splitted = text.split('|');
        var checkregex = /\~?([a-zA-Z0-9\-]+\.)*[a-zA-Z]+/;
        for (var i in splitted) {
          var matches = splitted[i].match(checkregex);
          if (!matches || matches[0] != splitted[i])
            return false;
        }
        return true;
      }

      function finally_it_has_loaded_its_stuff() {
        if (domaindata.features.debug_logging.is_enabled)
          $(".onlyifdebug").show()
        //create the table of resources and make it sortable
        generateTable();
        $("#resourceslist").tablesorter({
          headers: { 0: { sorter: false}},
          cancelSelection: true,
          sortList: [[3,0],[1,0],[3,0]]
        });
        $("#resourceslist tbody tr").mouseenter(function() {
          if ($(this).hasClass('selected'))
            return;
          $(this).children(":not(:first-child)").
            css("border-top", "black 1px dotted").
            css("border-bottom", "black 1px dotted");
        });
        $("#resourceslist tr").mouseleave(function() {
          $(this).children().
            css("border", "none");
        });

        //close the legend
        $("#legend a").click(function(event) {
          event.preventDefault();
          $("#legend").remove();
        });

        //An item has been selected
        $('.clickableRow, input:enabled', '#resourceslist').click(function() {
          if ($('.selected','#resourceslist').length > 0)
            return; //already selected a resource
          $(this).parents('tr').addClass('selected');
          $("#resourceslist tr:not(.selected)").remove();
          $("#resourceslist tr input").
            attr('checked', 'checked').
            attr('disabled', 'disabled');
          $('.clickableRow').removeClass('clickableRow');
          $('#resourceslist tr').css('border', 'black 1px dotted');
          $('#legend').remove();
          
          //Show the 'choose url' area
          $("#selectblockableurl").show();
          generateFilterSuggestions();
          //If the user clicks the 'next' button
          $("#confirmUrl").click(function() {
            if (($('#custom:checked').length == 1 && $('#customurl').val().trim() == '')) {
              alert('Please enter a valid URL pattern to match!');
              return;
            }
            //Hide unused stuff
            $("#selectblockableurl input:radio:not(:checked)").nextUntil('input').remove();
            $("#selectblockableurl input:radio:not(:checked)").remove();
            $("#confirmUrl").next().remove();
            $("#confirmUrl").remove();
            $("#selectblockableurl *:not(br):not(b)").attr("disabled", "disabled");

            //Show the options
            $("#chooseoptions").show();
            var domainOfSelectedUrl = $(".selected td:nth-of-type(2)").
                attr('title').replace(/^[a-z]{0,5}\:\/\//, '').match(/^[^\/]+/)[0];
            var isThirdParty = CheckThirdParty(domain, domainOfSelectedUrl);
            if (!isThirdParty) {
              $("#thirdparty + * + *").remove();
              $("#thirdparty + *").remove();
              $("#thirdparty").remove();
            } else
              $("#thirdparty + label").html("Any website EXCEPT websites on domain <i>" + 
                GetThirdPartyDomain(domainOfSelectedUrl) + "</i>");
            $("#domainlist").
              val(domain.replace(/^www\./, '')).
              click(function() {
                $("#domainis").
                  attr("checked", "checked").
                  change();
              }).
              keyup(function() {
                if (isValidDomainList($(this).val().trim().replace(/[a-z](\ |\,\ |\;\ |\;|\,)[\~a-z0-9]/gi,'a|a'))){
                  $("#domainis").val('domain=' + $(this).val().trim().replace(/\ |\,|\;/g,'|'));
                  $("#domainlist").css('color', 'black');
                } else {
                  $("#domainis").val('');
                  $("#domainlist").css('color', 'red');
                }
                $("#filterpreview").text(createfilter());
              });
            $("#domainis").val('domain=' + domain.replace(/^www\./, ''));
            var selectorForFixedType = '[value="~' + $(".selected td:nth-of-type(3)").attr('i18n') + '"]';
            $(selectorForFixedType).attr('disabled', 'disabled');

            //Update the preview filter
            $("#chooseoptions *").change(function() {
              $("#filterpreview").text(createfilter());
            });
            $("#filterpreview").text(createfilter());

            //Add the filter
            $("#addthefilter").click(function() {
              extension_call('add_custom_filter', { filter: createfilter() }, function() {
                alert("The filter was succesfully added!\nReload the page to see the result!");
                window.close();
              });
            });
          });
        });
      }
      
      $(function() {
        if (window.location.search) {
          //can be of the forms
          //  ?resourcetype=resourceURL&domain=domain
          //  ?domain=domain
          var query = window.location.search.substring(1);
          domain = unescape(query.match(/(^|\&)domain\=(.*)$/)[2]);
          query = query.replace(/(^|\&)domain\=(.*)$/, '');
          var temp_resource = query.match(/^(.+)\=(.+)$/);
          if (temp_resource) {
            var temp_url = unescape(temp_resource[2]);
            var temp_type = temp_resource[1];
            resources[temp_url] = {type:temp_type};
          }
        }

        $(window).unload(function() {
          localStorage.setItem('last_resources', JSON.stringify(loaded_resources));
        });

        var opts = { domain: domain, include_filters: true, is_top_frame: true };
        if (!domain) {
          alert('Something went wrong. No domain has been send through. This page will now close.');
          window.close();
          return;          
        }
        extension_call('get_content_script_data', opts, function(data) {
          delete data.selectors;
          domaindata = data;
          if (data.page_is_whitelisted || data.adblock_is_paused) {
            alert('This page is whitelisted or AdBlock is paused. Therefore no resources are caught, so this page cannot be used');
            window.close();
            return;
          }
          var localstoragekey = "resources" + domain.replace(/(\.|\-)/g, '_');
          loaded_resources = JSON.parse(localStorage.getItem(localstoragekey));
          if (!loaded_resources || loaded_resources.length == 0) {
            loaded_resources = JSON.parse(localStorage.getItem('last_resources'));
            if (!loaded_resources || loaded_resources.length == 0) {
              alert('No resources loaded... this page will now close!');
              window.close();
              return;
            }
          }
          for (var i=0; i<loaded_resources.length; i++) {
            if (/^HIDE\:.+/.test(loaded_resources[i])) {
              var filter = "##" + loaded_resources[i].substring(5);
              resources[filter] = {filter: filter};
            } else {
              var blockmatches = loaded_resources[i].split(':|:', 2);
              resources[blockmatches[1]] = {type:Number(blockmatches[0])};
            }
          }
          localStorage.removeItem(localstoragekey);
          finally_it_has_loaded_its_stuff();
          //if opened by the context menu, this variable exists
          if (temp_url)
            $("#resourceslist input").click();
        });
      });
    </script>
  </head>
  <body>
    <h1 class="icon">AdBlock</h1>
    <b>Select the resource you would like to block or unblock</b>
    <table id="resourceslist">
      <thead><tr>
        <th></th>
        <th>Resource</th>
        <th>Type</th>
        <th>Matched filter</th>
      </tr></thead>
      <tbody><tr id="loading"><td colspan="4" style="text-align:center;color:blue;font-size:22px;font-weight:bold;">0LOADING...</td></tr></tbody>
    </table>
    <div id="legend"><b">Legend:</b> <i style="color:red">blocked resources</i>, <i style="color:green">whitelisted resources</i> &amp; <i>blockable resources</i><span class="onlyifdebug">; <i style="color:blue">hiding rules applied</i></span>.&nbsp;&nbsp;<a href="#">(x)</a></div>
    
    <form id="selectblockableurl" style="display:none;">
      <b></b>
      <div id="suggestions"></div>
      <input type='radio' name='urloption' id='custom' />
      <label for='custom'></label><br/>
      <input type='button' style='margin-left:22px;' value='Next step' id='confirmUrl' />
    </form>

    <form id="chooseoptions" style="display:none;">
      <b>This filter will be applied when you are browsing:</b><br/>
      <input type="radio" name="domainoptions" value="" checked="checked" id="onEverySite" /><label for="onEverySite">Any website</label><br/>
      <input type="radio" name="domainoptions" id="thirdparty" value="third-party" /><label for="thirdparty"></label><br/>
      <input type="radio" name="domainoptions" id="domainis" /><label for="domainis">ONLY pages on these domains: </label>
      <input type="text" size="30" id="domainlist" title="Seperate multiple domains with commas or spaces"/><br/><br/>
      <b>This filter is case sensitive:</b><br/>
      <input type="radio" name="caseoption" value="match-case" id='matchcaseYes'/><label for="matchcaseYes">Yes</label> 
      <input type="radio" name="caseoption" value="" checked="checked" id='matchcaseNo'/><label for="matchcaseNo">No</label><br/><br/>
      <b>This filter applies to resources of these types:</b><br/>
      <div id="types">
        <input type="checkbox" value="~media" checked="checked" id="typemed"/><label for='typemed'>Audio and video</label>
        <input type="checkbox" value="~subdocument" checked="checked" id="typesub" /><label for='typesub'>Frames</label>
        <input type="checkbox" value="~object" checked="checked" id="typeobj" /><label for='typeobj'>Interactive objects</label>
        <input type="checkbox" value="~image" checked="checked" id="typeimg"/><label for='typeimg'>Images</label>
        <input type="checkbox" value="~script" checked="checked" id='typescr'/><label for='typescr'>Scripts</label>
        <input type="checkbox" value="~stylesheet" checked="checked" id='typesty'/><label for='typesty'>Style definitions</label><br/><br/>
      </div>
      <input type="button" id="addthefilter" value="Add this filter"/> <span id="filterpreview"></span>
    </form>
  </body>
</html>
