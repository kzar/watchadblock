<!--TODO
call localizePage()
perform i18n changes/translate() calls
clean up code; match 80chars/line rule
Optional: display resources from subframes?
-->
<html>
  <head>
    <title>Block a resource</title>
    <link rel="stylesheet" type="text/css" href="../options/options.css" />
    <script src="../port.js" type="text/javascript"></script>
    <script src="../jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
    <script src="../jquery/jquery.tablesorter.min.js" type="text/javascript"></script>
    <script src="../functions.js" type="text/javascript"></script>
    <script src="../filtering/filteroptions.js" type="text/javascript"></script>
    <script src="../filtering/filtertypes.js" type="text/javascript"></script>
    <script src="../filtering/fifocache.js" type="text/javascript"></script>
    <script src="../filtering/filterset.js" type="text/javascript"></script>
    <style type="text/css">
      .icon {
        background-image:url('../img/icon32.png')
      }
      input:disabled + label {
        cursor:default;
      }
      #resourceslist {
        text-align: left;
        cursor: default;
        width: 100%;
        margin-bottom:10px;
      }
      .header {
        background-image: url(../img/sort.gif);	
        cursor: pointer;
        background-repeat: no-repeat;
        background-position: center left;
        padding-left: 20px;
      }
      .headerSortDown {
        background-image: url(../img/sortdesc.gif);	
      }
      .headerSortUp {
        background-image: url(../img/sortasc.gif);	
      }
      #resourceslist td, #selectblockableurl :not(#confirmUrl):not(b) {
        font-size: 12px;
        padding: 0px;
        padding-right: 5px;
      }
      #resourceslist tbody td:last-of-type:first-letter {
        visibility:hidden;
      }
      .blocked {
        color:red;
      }
      .whitelisted {
        color:green;
      }
      #legend {
        font-size: 12px;
        background-color: white;
        position:fixed;
        top: 25px;
        right: 10px;
        padding: 5px;
      }
      .hiding {
        color:blue;
      }
      .clickableRow {
        cursor: pointer;
      }
      #selectblockableurl input:radio {
        margin-right: 7px;
      }
      #filterpreview {
        font-size:12px;
        font-style:italic;
      }
      .onlyifdebug {
        display:none;
      }
      #addthefilter {
        font-weight:bold;
        font-size:15px;
      }
    </style>
    <script type="text/javascript">
      var domain = '';
      var resources = [];
      var domaindata;

      function generateTable() {
        //find matching filters
        var local_filterset = FilterSet.fromText(domaindata.filtertext, undefined, true);
        var _limited_to_domain = local_filterset.limitedToDomain(domain);
        delete domaindata;

        //Generate the table containing all resources
        function truncateI(j) {
          if (j.length > 90)
            if (j.indexOf('?') > 43 && j.indexOf('?') <= 85)
              j = j.substring(0, j.indexOf('?') + 1) + '[...]';
          if (j.length > 90)
            j = j.substring(0, 86) + '[...]';
          return j;
        }
        function getTypeName(type) {
          switch(type) {
            case undefined: return "hiding";
            case ElementTypes.script: return "script";
            case ElementTypes.image: return "image";
            case ElementTypes.background: return "image";
            case ElementTypes.stylesheet: return "style definition";
            case ElementTypes.object: return "interactive object";
            case ElementTypes.subdocument: return "frame";
            case ElementTypes.media: return "audio/video";
            default: return "unknown";
          }
        }
        var rows = [];
        for (var i in resources) {
          var matchingfilter = resources[i].filter;
          if (!matchingfilter)
            matchingfilter = _limited_to_domain.matches(i, resources[i].type, true);

          var type = {sort:3, name:undefined};
          if (matchingfilter)
            if (matchingfilter[0] == '@')
              type = {sort:2, name:'whitelisted'};
            else if (i[0] == '#')
              type = {sort:0, name:'hiding'};
            else
              type = {sort:1, name:'blocked'};

          var thisrow = "<tr" + (type.name ? ' class="' + type.name + '"' : '') + ">";
          var disabled = (type.name == 'whitelisted' || type.name == 'hiding');
          thisrow += "<td><input type='checkbox'" + (disabled ? ' disabled="disabled"' : '') + "/></td>";
          disabled = (disabled ? '' : ' class="clickableRow"');
          thisrow += "<td" + disabled + " title='" + i + "'>" + truncateI(i) + "</td>";
          thisrow += "<td" + disabled + " i18n='" + getTypeName(resources[i].type) + "'>" + getTypeName(resources[i].type) + "</td>";
          thisrow += "<td" + disabled + ">" + (type.name ? type.sort + matchingfilter : '3-') + "</td>";
          thisrow += "</tr>";
          rows.push(thisrow);
        }
        $("#loading").remove();
        $("#resourceslist tbody").append(rows.join(''));
      };

      //Generate a list of pre-defined url filters
      function generateFilterSuggestions() {
        var url = $(".selected td:nth-of-type(2)").attr('title');
        url = url.replace(/\W{5}\(.*\)$/, '').replace(/\#.*$/, '');
        var isBlocked = ($(".selected").hasClass("blocked"));
        var blocksuggestions = [];
        var strippedUrl = url.replace(/^[a-z]{0,5}\:\/\/(www\.)?/, '');
        blocksuggestions.push(strippedUrl);
        if (strippedUrl.indexOf("?") > 0 || strippedUrl.indexOf("#") > 0) {
          strippedUrl = strippedUrl.replace(/(\?|\#).*/, '');
          blocksuggestions.push(strippedUrl);
        }
        if (strippedUrl.indexOf("/") > 0 && 
            strippedUrl.lastIndexOf('/') != strippedUrl.indexOf('/')) {
          strippedUrl = strippedUrl.substr(0, strippedUrl.lastIndexOf('/') + 1);
          blocksuggestions.push(strippedUrl);
        }
        if (strippedUrl.indexOf('/') > 0) {
          strippedUrl = strippedUrl.substr(0, strippedUrl.indexOf('/'));
          blocksuggestions.push(strippedUrl);
        }
        if (strippedUrl.indexOf('.') != strippedUrl.lastIndexOf('.')) {
          if (strippedUrl.replace('.co.', '').indexOf('.') != -1) {
            strippedUrl = strippedUrl.match(/[^.]+\.(co\.)?[^.]+$/i)[0];
            blocksuggestions.push(strippedUrl);
          }
        }

        var suggestions = [];
        for (var i in blocksuggestions) {
          suggestions.push("<input type='radio' name='urloption' id='suggest_" + i + "' value='" +
              (isBlocked ? '@@||' : '||') + blocksuggestions[i] + "'/>" +
              "<label for='suggest_" + i + "'> " + blocksuggestions[i] + "</label><br/>");
        }
        $("#suggestions").html(suggestions.join(''));
        if ($("#suggestions").find('input:first-child').val().indexOf('?') > 0)
          $($("#suggestions").children('input')[1]).attr('checked', 'checked');
        else
          $("#suggestions").find('input:first-child').attr('checked', 'checked');
        
        if (!isBlocked)
          $("#selectblockableurl b").text("Block every resource containing:");
        else
          $("#selectblockableurl b").text("Whitelist every resource containing:");
        $("#custom + label").
          html("Custom: <input type='text' id='customurl' value='" + url + 
          "' size='99' title='Note: you can use * as wildcard here'/>");
      }

      //Create the filter that will be applied
      function createfilter() {
        var isBlocked = ($(".selected").hasClass("blocked"));
        var urlfilter = '';
        if ($('#selectblockableurl #customurl').length != 0)
          urlfilter = (isBlocked ? '@@' : '') + $('#customurl').val();
        else
          urlfilter = $('#selectblockableurl input').val();
        if ((/^(\@\@)?\/.*\/$/).test(urlfilter))
          urlfilter += '*';

        var options = [];
        $("#chooseoptions > input:checked, #types > input:not(:checked)").each(function() {
          if ($(this).val())
            options.push($(this).val());
        });

        return urlfilter + ((options.length != 0) ? '$' + options.join(',') : '');
      }

      function CheckThirdParty(domain1, domain2) {
        var match1 = domain1.match(/[^.]+\.(co\.)?[^.]+$/) || [ domain1 ];
        var match2 = domain2.match(/[^.]+\.(co\.)?[^.]+$/) || [ domain2 ];
        return (match1[0].toLowerCase() != match2[0].toLowerCase());
      }
      function GetThirdPartyDomain(domain) {
        var match = domain.match(/[^.]+\.(co\.)?[^.]+$/) || [ domain ];
        return match[0].toLowerCase();
      }

      function isValidDomainList(text) {
        var splitted = text.split('|');
        var checkregex = /\~?([a-zA-Z0-9\-]+\.)*[a-zA-Z]+/;
        for (var i in splitted) {
          var matches = splitted[i].match(checkregex);
          if (!matches || matches[0] != splitted[i])
            return false;
        }
        return true;
      }

      function finally_it_has_loaded_its_stuff() {
        if (domaindata.features.debug_logging.is_enabled)
          $(".onlyifdebug").show()
        //create the table of resources and make it sortable
        generateTable();
        $("#resourceslist").tablesorter({
          headers: { 0: { sorter: false}},
          cancelSelection: true,
          sortList: [[3,0],[1,0],[3,0]]
        });
        $("#resourceslist tbody tr").mouseenter(function() {
          if ($(this).hasClass('selected'))
            return;
          $(this).children(":not(:first-child)").
            css("border-top", "black 1px dotted").
            css("border-bottom", "black 1px dotted");
        });
        $("#resourceslist tr").mouseleave(function() {
          $(this).children().
            css("border", "none");
        });

        //close the legend
        $("#legend a").click(function(event) {
          event.preventDefault();
          $("#legend").remove();
        });

        //An item has been selected
        $('.clickableRow, input:enabled', '#resourceslist').click(function() {
          if ($('.selected','#resourceslist').length > 0)
            return; //already selected a resource
          $(this).parents('tr').addClass('selected');
          $("#resourceslist tr:not(.selected)").remove();
          $("#resourceslist tr input").
            attr('checked', 'checked').
            attr('disabled', 'disabled');
          $('.clickableRow').removeClass('clickableRow');
          $('#resourceslist tr').css('border', 'black 1px dotted');
          $('#legend').remove();
          
          //Show the 'choose url' area
          $("#selectblockableurl").show();
          generateFilterSuggestions();
          //If the user clicks the 'next' button
          $("#confirmUrl").click(function() {
            if (($('#custom:checked').length == 1 && $('#customurl').val().trim() == '')) {
              alert('Please enter a valid URL pattern to match!');
              return;
            }
            //Hide unused stuff
            $("#selectblockableurl input:radio:not(:checked)").nextUntil('input').remove();
            $("#selectblockableurl input:radio:not(:checked)").remove();
            $("#confirmUrl").next().remove();
            $("#confirmUrl").remove();
            $("#selectblockableurl *:not(br):not(b)").attr("disabled", "disabled");

            //Show the options
            $("#chooseoptions").show();
            var domainOfSelectedUrl = $(".selected td:nth-of-type(2)").
                attr('title').replace(/^[a-z]{0,5}\:\/\//, '').match(/^[^\/]+/)[0];
            var isThirdParty = CheckThirdParty(domain, domainOfSelectedUrl);
            if (!isThirdParty) {
              $("#thirdparty + * + *").remove();
              $("#thirdparty + *").remove();
              $("#thirdparty").remove();
            } else
              $("#thirdparty + label").html("Any website EXCEPT websites on domain <i>" + 
                GetThirdPartyDomain(domainOfSelectedUrl) + "</i>");
            $("#domainlist").
              val(domain.replace(/^www\./, '')).
              click(function() {
                $("#domainis").
                  attr("checked", "checked").
                  change();
              }).
              keyup(function() {
                if (isValidDomainList($(this).val().trim().replace(/[a-z](\ |\,\ |\;\ |\;|\,)[\~a-z0-9]/gi,'a|a'))){
                  $("#domainis").val('domain=' + $(this).val().trim().replace(/\ |\,|\;/g,'|'));
                  $("#domainlist").css('color', 'black');
                } else {
                  $("#domainis").val('');
                  $("#domainlist").css('color', 'red');
                }
                $("#filterpreview").text(createfilter());
              });
            $("#domainis").val('domain=' + domain.replace(/^www\./, ''));
            var selectorForFixedType = '[value="~' + $(".selected td:nth-of-type(3)").attr('i18n') + '"]';
            $(selectorForFixedType).attr('disabled', 'disabled');

            //Update the preview filter
            $("#chooseoptions *").change(function() {
              $("#filterpreview").text(createfilter());
            });
            $("#filterpreview").text(createfilter());

            //Add the filter
            $("#addthefilter").click(function() {
              extension_call('add_custom_filter', { filter: createfilter() }, function() {
                alert("The filter was succesfully added!\nReload the page to see the result!");
                window.close();
              });
            });
          });
        });
      }
      
      $(function() {
        if (window.location.search) {
          //can be of the forms
          //  ?resourcetype=resourceURL&domain=domain
          //  ?domain=domain
          var query = window.location.search.substring(1);
          domain = unescape(query.match(/(^|\&)domain\=(.*)$/)[2]);
          query = query.replace(/(^|\&)domain\=(.*)$/, '');
          var temp_resource = query.match(/^(.+)\=(.+)$/);
          if (temp_resource) {
            var temp_url = unescape(temp_resource[2]);
            var temp_type = temp_resource[1];
            resources[temp_url] = {type:temp_type};
          }
        }

        $(window).unload(function() {
          localStorage.setItem('last_resources', JSON.stringify(loaded_resources));
        });

        var opts = { domain: domain, include_filters: true, is_top_frame: true };
        if (!domain) {
          alert('Something went wrong. No domain has been send through. This page will now close.');
          window.close();
          return;          
        }
        extension_call('get_content_script_data', opts, function(data) {
          delete data.selectors;
          domaindata = data;
          if (data.page_is_whitelisted || data.adblock_is_paused) {
            alert('This page is whitelisted or AdBlock is paused. Therefore no resources are caught, so this page cannot be used');
            window.close();
            return;
          }
          var localstoragekey = "resources" + domain.replace(/(\.|\-)/g, '_');
          loaded_resources = JSON.parse(localStorage.getItem(localstoragekey));
          if (!loaded_resources || loaded_resources.length == 0) {
            loaded_resources = JSON.parse(localStorage.getItem('last_resources'));
            if (!loaded_resources || loaded_resources.length == 0) {
              alert('No resources loaded... this page will now close!');
              window.close();
              return;
            }
          }
          for (var i=0; i<loaded_resources.length; i++) {
            if (/^HIDE\:.+/.test(loaded_resources[i])) {
              var filter = "##" + loaded_resources[i].substring(5);
              resources[filter] = {filter: filter};
            } else {
              var blockmatches = loaded_resources[i].split(':|:', 2);
              resources[blockmatches[1]] = {type:Number(blockmatches[0])};
            }
          }
          localStorage.removeItem(localstoragekey);
          finally_it_has_loaded_its_stuff();
          //if opened by the context menu, this variable exists
          if (temp_url)
            $("#resourceslist input").click();
        });
      });
    </script>
  </head>
  <body>
    <h1 class="icon">AdBlock</h1>
    <b>Select the resource you would like to block or unblock</b>
    <table id="resourceslist">
      <thead><tr>
        <th></th>
        <th>Resource</th>
        <th>Type</th>
        <th>Matched filter</th>
      </tr></thead>
      <tbody><tr id="loading"><td colspan="4" style="text-align:center;color:blue;font-size:22px;font-weight:bold;">0LOADING...</td></tr></tbody>
    </table>
    <div id="legend"><b">Legend:</b> <i style="color:red">blocked resources</i>, <i style="color:green">whitelisted resources</i> &amp; <i>blockable resources</i><span class="onlyifdebug">; <i style="color:blue">hiding rules applied</i></span>.&nbsp;&nbsp;<a href="#">(x)</a></div>
    
    <form id="selectblockableurl" style="display:none;">
      <b></b>
      <div id="suggestions"></div>
      <input type='radio' name='urloption' id='custom' />
      <label for='custom'></label><br/>
      <input type='button' style='margin-left:22px;' value='Next step' id='confirmUrl' />
    </form>

    <form id="chooseoptions" style="display:none;">
      <b>This filter will be applied when you are browsing:</b><br/>
      <input type="radio" name="domainoptions" value="" checked="checked" id="onEverySite" /><label for="onEverySite">Any website</label><br/>
      <input type="radio" name="domainoptions" id="thirdparty" value="third-party" /><label for="thirdparty"></label><br/>
      <input type="radio" name="domainoptions" id="domainis" /><label for="domainis">ONLY pages on these domains: </label>
      <input type="text" size="30" id="domainlist" title="Seperate multiple domains with commas or spaces"/><br/><br/>
      <b>This filter is case sensitive:</b><br/>
      <input type="radio" name="caseoption" value="match-case" id='matchcaseYes'/><label for="matchcaseYes">Yes</label> 
      <input type="radio" name="caseoption" value="" checked="checked" id='matchcaseNo'/><label for="matchcaseNo">No</label><br/><br/>
      <b>This filter applies to resources of these types:</b><br/>
      <div id="types">
        <input type="checkbox" value="~media" checked="checked" id="typemed"/><label for='typemed'>Audio and video</label>
        <input type="checkbox" value="~subdocument" checked="checked" id="typesub" /><label for='typesub'>Frames</label>
        <input type="checkbox" value="~object" checked="checked" id="typeobj" /><label for='typeobj'>Interactive objects</label>
        <input type="checkbox" value="~image" checked="checked" id="typeimg"/><label for='typeimg'>Images</label>
        <input type="checkbox" value="~script" checked="checked" id='typescr'/><label for='typescr'>Scripts</label>
        <input type="checkbox" value="~stylesheet" checked="checked" id='typesty'/><label for='typesty'>Style definitions</label><br/><br/>
      </div>
      <input type="button" id="addthefilter" value="Add this filter"/> <span id="filterpreview"></span>
    </form>
  </body>
</html>
