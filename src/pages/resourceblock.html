<html>
  <head>
    <title i18n="resourceblocktitle"></title>
    <link rel="stylesheet" type="text/css" href="../options/options.css" />
    <script src="../port.js" type="text/javascript"></script>
    <script src="../jquery/jquery-1.4.4-hacked-up.min.js" type="text/javascript"></script>
    <script src="../jquery/jquery.tablesorter.min.js" type="text/javascript"></script>
    <script src="../functions.js" type="text/javascript"></script>
    <script src="../filtering/filteroptions.js" type="text/javascript"></script>
    <script src="../filtering/filtertypes.js" type="text/javascript"></script>
    <script src="../filtering/fifocache.js" type="text/javascript"></script>
    <script src="../filtering/filterset.js" type="text/javascript"></script>
    <script src="../filtering/filternormalizer.js" type="text/javascript"></script>
    <style type="text/css">
      .icon {
        background-image:url('../img/icon32.png')
      }
      input:disabled + label {
        cursor:default;
      }
      #resourceslist {
        text-align: left;
        cursor: default;
        width: 100%;
        margin-bottom:10px;
      }
      .header {
        background-image: url(../img/sort.gif);	
        cursor: pointer;
        background-repeat: no-repeat;
        background-position: center left;
        padding-left: 20px;
      }
      .headerSortDown {
        background-image: url(../img/sortdesc.gif);	
      }
      .headerSortUp {
        background-image: url(../img/sortasc.gif);	
      }
      #resourceslist td, #selectblockableurl :not(#confirmUrl):not(b) {
        font-size: 12px;
        padding: 0px;
        padding-right: 5px;
      }
      .sorter {
        display:none;
      }
      .blocked {
        color:red;
      }
      .whitelisted {
        color:green;
      }
      #legend {
        font-size: 12px;
        background-color: white;
        position:fixed;
        top: 25px;
        right: 10px;
        padding: 5px;
      }
      .hiding {
        color:blue;
      }
      .clickableRow {
        cursor: pointer;
      }
      .deleterule {
        cursor: pointer;
        background-image: url(../img/delete.gif);
        background-repeat: no-repeat;
        background-position: center left;
        width: 9px;
      }
      #selectblockableurl input:radio {
        margin-right: 7px;
      }
      #filterpreview {
        font-size:12px;
        font-style:italic;
      }
      .onlyifdebug {
        display:none;
      }
      #addthefilter {
        font-weight:bold;
        font-size:15px;
      }
      #loading td {
        text-align:center;
        color:blue;
        font-size:22px;
        font-weight:bold;
      }
    </style>
    <script type="text/javascript">
      var domain = '';
      var resources = [];
      var domaindata;
      var custom_filters = [];

      // Creates the table that shows all blockable items
      function generateTable() {
        var local_filterset = FilterSet.fromText(domaindata.block, false, false);
        var _limited_to_domain = local_filterset.limitedToDomain(domain);
        delete domaindata;

        // Trunkates a resource URL if it is too long
        // Inputs: the string to truncate
        // Returns the truncated string
        function truncateI(j) {
          if (j.length > 90)
            if (j.indexOf('?') > 43 && j.indexOf('?') <= 85)
              j = j.substring(0, j.indexOf('?') + 1) + '[...]';
          if (j.length > 90)
            j = j.substring(0, 86) + '[...]';
          return j;
        }
        // Converts the ElementTypes number back into an readable string
        // or hiding or 'unknown' if it wasn't in ElementTypes.
        // Inputs: One out of ElementTypes or 'undefined'
        // Returns a string with the element type
        function getTypeName(type) {
          switch(type) {
            case undefined: return "hiding";
            case ElementTypes.script: return "script";
            case ElementTypes.image: return "image";
            case ElementTypes.background: return "image";
            case ElementTypes.stylesheet: return "stylesheet";
            case ElementTypes.object: return "object";
            case ElementTypes.subdocument: return "subdocument";
            case ElementTypes.media: return "media";
            default: return "unknown";
          }
        }
        // Checks if the filter is in the custom filters and can be removed
        // Inputs: the filter that could be in the custom filters
        // Returns true if the filter was in the custom filters
        function inCustomFilters(filter) {
          if (!filter) return false;
          for (var i=0; i<custom_filters.length; i++)
            if (matchingfilter == custom_filters[i])
              return true;
          return false;
        }
        
        // Now create that table row-by-row
        var rows = [];
        for (var i in resources) {
          var matchingfilter = resources[i].filter;
          if (!matchingfilter)
            matchingfilter = _limited_to_domain.matches(i, resources[i].type, domain, true);

          var type = {sort:3, name:undefined};
          if (matchingfilter)
            if (matchingfilter[0] == '@')
              type = {sort:2, name:'whitelisted'};
            else if (i[0] == '#')
              type = {sort:0, name:'hiding'};
            else
              type = {sort:1, name:'blocked'};

          var thisrow = "<tr" + (type.name ? ' class="' + type.name + '"' : '') + ">";
          var disabled = (type.name == 'whitelisted' || type.name == 'hiding');
          thisrow += "<td><input type='checkbox'" + (disabled ? 
                                       ' disabled="disabled"' : '') + "/></td>";
          disabled = (disabled ? '' : ' class="clickableRow"');
          thisrow += "<td" + disabled + " title='" + i + "'>" + truncateI(i) + "</td>";
          var typeName = getTypeName(resources[i].type);
          thisrow += "<td" + disabled + " name='" + typeName + "'>"
                     + translate('type' + typeName) + "</td>";
          thisrow += "<td" + disabled + ">" + (type.name ? "<span class='sorter'>" +
                                               type.sort + "</span>" + matchingfilter :
                                               "<span class='sorter'>3</span>-") + "</td>";
          if (inCustomFilters(matchingfilter))
            thisrow += "<td class='deleterule' title='" +
                       translate("removelabel") + "'></td>";
          else
            thisrow += "<td></td>";
          thisrow += "</tr>";
          rows.push(thisrow);
        }
        $("#loading").remove();
        $("#resourceslist tbody").append(rows.join(''));
        $(".deleterule").click(function() {
          var filter = $(this).prev().text().substring(1);
          extension_call('remove_custom_filter', {filter: filter}, function() {
            document.location.reload();
          });
        });
      };

      //Generate a list of pre-defined url filters
      function generateFilterSuggestions() {
        var url = $(".selected td:nth-of-type(2)").attr('title');
        url = url.replace(/\W{5}\(.*\)$/, '').replace(/\#.*$/, '');
        var isBlocked = ($(".selected").hasClass("blocked"));
        var blocksuggestions = [];
        var strippedUrl = url.replace(/^[a-z]{0,5}\:\/\/(www\.)?/, '');
        blocksuggestions.push(strippedUrl);
        if (strippedUrl.indexOf("?") > 0 || strippedUrl.indexOf("#") > 0) {
          strippedUrl = strippedUrl.replace(/(\?|\#).*/, '');
          blocksuggestions.push(strippedUrl);
        }
        if (strippedUrl.indexOf("/") > 0 && 
            strippedUrl.lastIndexOf('/') != strippedUrl.indexOf('/')) {
          strippedUrl = strippedUrl.substr(0, strippedUrl.lastIndexOf('/') + 1);
          blocksuggestions.push(strippedUrl);
        }
        if (strippedUrl.indexOf('/') > 0) {
          strippedUrl = strippedUrl.substr(0, strippedUrl.indexOf('/'));
          blocksuggestions.push(strippedUrl);
        }
        if (strippedUrl.indexOf('.') != strippedUrl.lastIndexOf('.')) {
          if (strippedUrl.replace('.co.', '').indexOf('.') != -1) {
            strippedUrl = strippedUrl.match(/[^.]+\.(co\.)?[^.]+$/i)[0];
            blocksuggestions.push(strippedUrl);
          }
        }

        var suggestions = [];
        for (var i in blocksuggestions) {
          suggestions.push("<input type='radio' name='urloption' id='suggest_" +
                           i + "' value='" + (isBlocked ? '@@||' : '||') + 
                           blocksuggestions[i] + "'/>" + "<label for='suggest_" +
                           i + "'> " + blocksuggestions[i] + "</label><br/>");
        }
        $("#suggestions").html(suggestions.join(''));
        if ($("#suggestions").find('input:first-child').val().indexOf('?') > 0)
          $($("#suggestions").children('input')[1]).attr('checked', 'checked');
        else
          $("#suggestions").find('input:first-child').attr('checked', 'checked');
        
        if (!isBlocked)
          $("#selectblockableurl b").text(translate("blockeverycontaining"));
        else
          $("#selectblockableurl b").text(translate("whitelisteverycontaining"));
        $("#custom + label").
          html("Custom: <input type='text' id='customurl' value='" + url + 
          "' size='99' title='" + translate("wildcardhint") + "'/>");
      }

      // Create the filter that will be applied from the chosen options
      // Returns the filter
      function createfilter() {
        var isBlocked = ($(".selected").hasClass("blocked"));
        var urlfilter = '';
        if ($('#selectblockableurl #customurl').length != 0)
          urlfilter = (isBlocked ? '@@' : '') + $('#customurl').val();
        else
          urlfilter = $('#selectblockableurl input').val();
        if ((/^(\@\@)?\/.*\/$/).test(urlfilter))
          urlfilter += '*';

        var options = [];
        $("#chooseoptions > input:checked, #types > input:not(:checked)").each(
        function() {
          if ($(this).val())
            options.push($(this).val());
        });

        return urlfilter + ((options.length != 0) ? '$' + options.join(',') : '');
      }

      // Get the third-party domain
      // Inputs: the domain of which the third-party-check part is requested
      // Returns the third-party-check domain
      function GetThirdPartyDomain(domain) {
        var match = domain.match(/[^.]+\.(co\.)?[^.]+$/) || [ domain ];
        return match[0].toLowerCase();
      }

      // Checks if it is a third-party resource or not
      // Inputs: the two domains to check
      // Returns true if third-party, false otherwise
      function CheckThirdParty(domain1, domain2) {
        var match1 = GetThirdPartyDomain(domain1);
        var match2 = GetThirdPartyDomain(domain2);
        return (match1 != match2);
      }

      // Checks if the text in the domain list textbox is valid or not
      // Inputs: the text from the text box
      // Returns true if the domain list was valid, false otherwise
      function isValidDomainList(text) {
        if (!text)
          return false;
        try {
          FilterNormalizer.normalizeLine('*$domain=' + text);
          return true;
        } catch(ex) {
          return false;
        }
      }

      // After getting annoyed by the time it takes to get the required data
      // finally start generating some content for the user, and allowing him to
      // do some things, instead of looking at 'LOADING'
      function finally_it_has_loaded_its_stuff() {
        if (domaindata.features.debug_logging.is_enabled)
          $(".onlyifdebug").show()
        // Create the table of resources and make it sortable
        generateTable();
        $("#resourceslist").tablesorter({
          headers: { 0: {sorter:false}, 4: {sorter:false}},
          cancelSelection: true,
          sortList: [[3,0],[1,0],[3,0]]
        });
        $("#resourceslist tbody tr").mouseenter(function() {
          if ($(this).hasClass('selected'))
            return;
          $(this).children(":not(:first-child)").
            css("border-top", "black 1px dotted").
            css("border-bottom", "black 1px dotted");
        });
        $("#resourceslist tr").mouseleave(function() {
          $(this).children().
            css("border", "none");
        });

        // Close the legend
        $("#legend a").click(function(event) {
          event.preventDefault();
          $("#legend").remove();
        });

        // An item has been selected
        $('.clickableRow, input:enabled', '#resourceslist').click(function() {
          if ($('.selected','#resourceslist').length > 0)
            return; //already selected a resource
          $(this).parents('tr').addClass('selected');
          $("#resourceslist tr:not(.selected)").remove();
          $("#resourceslist tr input").
            attr('checked', 'checked').
            attr('disabled', 'disabled');
          $('.clickableRow').removeClass('clickableRow');
          $('#resourceslist tr').css('border', 'black 1px dotted');
          $('#legend').remove();
          
          // Show the 'choose url' area
          $("#selectblockableurl").show();
          generateFilterSuggestions();
          // If the user clicks the 'next' button
          $("#confirmUrl").click(function() {
            if ($('#custom:checked').length == 1 && 
                $('#customurl').val().trim() == '') {
              alert(translate('novalidurlpattern'));
              return;
            }
            // Hide unused stuff
            $("#selectblockableurl input:radio:not(:checked)").
                nextUntil('input').remove();
            $("#selectblockableurl input:radio:not(:checked)").remove();
            $("#confirmUrl").next().remove();
            $("#confirmUrl").remove();
            $("#selectblockableurl *:not(br):not(b)").attr("disabled", "disabled");

            // Show the options
            $("#chooseoptions").show();
            var domainOfSelectedUrl = $(".selected td:nth-of-type(2)").
                attr('title').replace(/^[a-z]{0,5}\:\/\//, '').match(/^[^\/]+/)[0];
            var isThirdParty = CheckThirdParty(domain, domainOfSelectedUrl);
            if (!isThirdParty) {
              $("#thirdparty + * + *").remove();
              $("#thirdparty + *").remove();
              $("#thirdparty").remove();
            } else
              $("#thirdparty + label").html(translate("thirdpartycheckbox", "<i>" + 
                GetThirdPartyDomain(domainOfSelectedUrl) + "</i>"));
            $("#domainlist").
              val(domain.replace(/^www\./, '')).
              click(function() {
                $("#domainis").
                  attr("checked", "checked").
                  change();
              }).
              keyup(function() {
                if (isValidDomainList($(this).val().trim().
                    replace(/[a-z](\ |\,\ ?|\;\ ?)\~?[a-z0-9]/gi,'a|a'))){
                  $("#domainis").val('domain=' + 
                      $(this).val().trim().replace(/(\ |\,|\;)+/g,'|'));
                  $("#domainlist").css('color', 'black');
                } else {
                  $("#domainis").val('');
                  $("#domainlist").css('color', 'red');
                }
                $("#filterpreview").text(createfilter());
              });
            $("#domainis").val('domain=' + domain.replace(/^www\./, ''));
            var selectorForFixedType = '[value="~' + 
                $(".selected td:nth-of-type(3)").attr('name') + '"]';
            $(selectorForFixedType).attr('disabled', 'disabled');

            // Update the preview filter
            $("#chooseoptions *").change(function() {
              $("#filterpreview").text(createfilter());
            });
            $("#filterpreview").text(createfilter());

            // Add the filter
            $("#addthefilter").click(function() {
              extension_call('add_custom_filter', { filter: createfilter() }, 
              function() {
                alert(translate("filterhasbeenadded"));
                window.close();
              });
            });
          });
        });
      }
      
      $(function() {
        // Translation
        localizePage();

        var url;
        if (window.location.search) {
          // Can be of the forms
          //  ?resourcetype=resourceURL&url=url
          //  ?url=url
          var query = window.location.search.substring(1);
          url = unescape(query.match(/(^|\&)url\=(.*)$/)[2]);
          domain = FilterSet._domainFor(url);
          query = query.replace(/(^|\&)url\=(.*)$/, '');
          var temp_resource = query.match(/^(.+)\=(.+)$/);
          if (temp_resource) {
            var temp_url = unescape(temp_resource[2]);
            var temp_type = temp_resource[1];
            resources[temp_url] = {type:ElementTypes[temp_type]};
          }
        }

        var opts = {
          domain: domain,
          include_filters: true,
          is_top_frame: true
        };
        extension_call('get_content_script_data', opts, function(data) {
          delete data.selectors;
          domaindata = data;
          if (data.page_is_whitelisted || data.adblock_is_paused) {
            alert(translate("whitelistedorpausedpage"));
            window.close();
            return;
          }
          if (!temp_url) {
            var bg = chrome.extension.getBackgroundPage();
            var cache = bg.show_resourceblocker.cached_resources;
            var loaded_resources = cache.get(url);
            if (!loaded_resources || loaded_resources.length == 0) {
              alert(translate('noresourcessend'));
              window.close();
              return;
            }
            for (var i=0; i<loaded_resources.length; i++) {
              if (/^HIDE\:.+/.test(loaded_resources[i])) {
                var filter = "##" + loaded_resources[i].substring(5);
                resources[filter] = {filter: filter};
              } else {
                var blockmatches = loaded_resources[i].split(':|:', 2);
                resources[blockmatches[1]] = {type: Number(blockmatches[0])};
              }
            }
          }
          extension_call('get_custom_filters_text', {}, function(filters) {
            filters = FilterNormalizer.normalizeList(filters);
            if (filters.replace('\n').length != 0) {
              filters = filters.split('\n');
              for (var i=0; i<filters.length; i++)
                if (!/\#\#/.test(filters[i]))
                  custom_filters.push(filters[i])
            }

            finally_it_has_loaded_its_stuff();
            // If opened by the context menu, this variable exists
            if (temp_url)
              if ($("#resourceslist input").attr("disabled")) {
                // In case the resource has been whitelisted and can't be removed
                if ($(".deleterule").length == 0) {
                  alert(translate('resourceiswhitelisted'));
                  window.close();
                  return;
                }
              } else
                $("#resourceslist input").click();
          });
        });
      });
    </script>
  </head>
  <body>
    <h1 class="icon">AdBlock</h1>
    <b i18n="selectresources"></b>
    <table id="resourceslist">
      <thead><tr>
        <th></th>
        <th i18n="headerresource"></th>
        <th i18n="headertype"></th>
        <th i18n="headerfilter"></th>
        <th></th>
      </tr></thead>
      <tbody><tr id="loading"><td colspan="4" i18n="loading"></td></tr></tbody>
    </table>

    <div id="legend"><b i18n="resourceblocklegend1"></b> 
    <i style='color:red' i18n="resourceblocklegend2"></i>, 
    <i style='color:green' i18n="resourceblocklegend3"></i> &amp; 
    <i i18n="resourceblocklegend4"></i><span class='onlyifdebug'>; 
    <i style='color:blue' i18n="resourceblocklegend5"></i></span>.&nbsp;&nbsp;
    <a href='#' i18n_title="close">(x)</a></div>

    <form id="selectblockableurl" style="display:none;">
      <b></b>
      <div id="suggestions"></div>
      <input type='radio' name='urloption' id='custom' />
      <label for='custom'></label><br/>
      <input type='button' style='margin-left:22px;' i18n_value='nextstep' id='confirmUrl' />
    </form>

    <form id="chooseoptions" style="display:none;">
      <b i18n="appliedwhenbrowsing"></b><br/>
      <input type="radio" name="domainoptions" value="" checked="checked" id="onEverySite" />
      <label for="onEverySite" i18n="anysite"></label><br/>
      <input type="radio" name="domainoptions" id="thirdparty" value="third-party" />
      <label for="thirdparty"></label><br/>
      <input type="radio" name="domainoptions" id="domainis" />
      <label for="domainis" i18n="onlyondomains"></label>
      <input type="text" size="30" id="domainlist" i18n_title="multipledomainshint"/><br/><br/>
      <b i18n="casesensitive"></b><br/>
      <input type="radio" name="caseoption" value="match-case" id='matchcaseYes'/>
      <label for="matchcaseYes" i18n="yes"></label> 
      <input type="radio" name="caseoption" value="" checked="checked" id='matchcaseNo'/>
      <label for="matchcaseNo" i18n="no"></label><br/><br/>
      <b i18n="onlyresourcetypes"></b><br/>
      <div id="types">
        <input type="checkbox" value="~media" checked="checked" id="typemed"/>
        <label for='typemed' i18n="typemedia"></label>
        <input type="checkbox" value="~subdocument" checked="checked" id="typesub" />
        <label for='typesub' i18n="typesubdocument"></label>
        <input type="checkbox" value="~object" checked="checked" id="typeobj" />
        <label for='typeobj' i18n="typeobject"></label>
        <input type="checkbox" value="~image" checked="checked" id="typeimg"/>
        <label for='typeimg' i18n="typeimage"></label>
        <input type="checkbox" value="~script" checked="checked" id='typescr'/>
        <label for='typescr' i18n="typescript"></label>
        <input type="checkbox" value="~stylesheet" checked="checked" id='typesty'/>
        <label for='typesty' i18n="typestylesheet"></label><br/><br/>
      </div>
      <input type="button" id="addthefilter" i18n_value="addthisfilter"/> 
      <span id="filterpreview"></span>
    </form>
  </body>
</html>
