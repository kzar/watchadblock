  <style type="text/css">
    #subscriptionlist {
      margin-top: 10px;
    }
    #subscriptionlist b {
      margin-top: 13px;
      display: block;
    }
    #subscriptionlist list:not(:empty) {
      display: block;
    }
    .listgroup i {
      font-size: 12px;
      margin-left: 20px;
    }
    select {
      width: 100px;
    }
    select + select, select + select + input {
      display: none;
    }
    .linkToList {
      margin-left: 6px;
      font-size: 11px;
      display: none;
    }
    .remove_filter {
      font-size: 11px;
      display: none;
    }
    list {
      margin-left: 20px;
    }
  </style>
  <script>
/*      var removeFlashMsgTimeout;
      function flash(message, duration) {
        $("#subscription_message").text(message);

        clearTimeout(removeFlashMsgTimeout);
        removeFlashMsgTimeout = window.setTimeout(function() {
          $("#subscription_message").text('');
        }, duration ? duration : 7500);
      }

      // Return a string representation of roughly how long ago the 
      // given ticks were, e.g. "just now" or "2 hours ago".  If ticks is
      // undefined, return blank.
      function how_long_ago(duration) {
        var seconds = Math.round(duration / 1000);
        if (seconds < 10)
          return translate("updatedrightnow");
        if (seconds < 60)
          return translate("updatedsecondsago", [seconds]);
        var minutes = Math.round(seconds / 60);
        if (minutes == 1)
          return translate("updatedminuteago");
        if (minutes < 60)
          return translate("updatedminutesago", [minutes]);
        var hours = Math.round(minutes / 60);
        if (hours == 1)
          return translate("updatedhourago");
        if (hours < 24)
          return translate("updatedhoursago", [hours]);
        var days = Math.round(hours / 24);
        if (days == 1)
          return translate("updateddayago");
        return translate("updateddaysago", [days]);
      }


      // If true, change events won't run.
      global_refreshing_subscription_view = false;
      // Cache the fetched subscriptions so we can update their times.
      global_subscriptions_cached_copy = undefined;

      // Update the "last updated" messages in the subscription view.
      function redisplay_subscription_update_times() {
        var subs = global_subscriptions_cached_copy;
        var lessThanMinute = false;
        if (subs == undefined)
          return;
        $(".subscription").each(function(i,el) {
          var when_text = "";
          var id = $("input", el).attr("name");
          if (subs[id] && subs[id].subscribed && subs[id].last_update) {
            var timeSinceUpdate = new Date().getTime() - subs[id].last_update;
            when_text = how_long_ago(timeSinceUpdate);
            if (timeSinceUpdate < 60000)
              lessThanMinute = true;
          }

          $(".update_time", el).text(when_text);
        });

        // Every so often, redisplay "last update" times on subscriptions.
        if (typeof lastUpdateInterval != "undefined") 
          clearInterval(lastUpdateInterval);
        lastUpdateInterval = window.setInterval(function() { 
          redisplay_subscription_update_times();
        }, lessThanMinute ? 1000 : 60000);
      }

      // Load the latest subscription model object and display it in
      // the checkboxes.
      function refresh_subscription_view() {
        extension_call('get_subscriptions_minus_text', {}, function(subs) {
          global_refreshing_subscription_view = true;

          $(".subscription").each(function(i,el) {
            var is_checked = "";

            var id = $("input", el).attr("name");
            if (subs[id] && subs[id].subscribed)
              is_checked = "checked";

            $("input", el).attr("checked", is_checked);

            if (subs[id] && subs[id].user_submitted && is_checked == false) {
              $(this).find(".remove_filter").css("display", "inline");
              $(this).closest("div").find(".update_time").text("");
            }
          });
          
          global_refreshing_subscription_view = false;

          // Keep this around to update the "last updated" displays.
          global_subscriptions_cached_copy = subs;
          redisplay_subscription_update_times();
        });
      }

      register_broadcast_listener('filters_updated', function() {
        refresh_subscription_view();
      });

      // Unsubscribe from the given filterlist id.
      // 'del' determines if it should be deleted too
      function unsubscribe(id, del) {
        extension_call("unsubscribe", {id:id, del:del}, function() {
          var message = (del) ? translate("removedlabel")
                              : translate("unsubscribedlabel");
          flash(message);
        });
      }
      // Subscribe to the given filterlist id.  id is either a well-known id, or
      // "url:xyz", where xyz is the URL of a user-specified filter list.
      // If you can't fetch the latest version of the list, fail.  If 
      // then_reload is specified and is true, reload the tab upon 
      // success.
      function subscribe(id, then_reload) {
        var url;
        if (id in global_subscriptions_cached_copy)
          url = global_subscriptions_cached_copy[id].url;
        else
          url = id.substring(4); // "url:xyz"

        flash(translate("fetchinglabel"), 60000);
        var onError = function() {
          alert(translate("failedtofetchfilter"));
          var myIndex = $("#tabpages").tabs("option", "selected");
          $("#tabpages").tabs("load", myIndex);
        }
        $.ajax({
          url: url,
          cache: false,
          success: function(text) {
            if (!text) {
              onError(); // not sure why we even get here, but we do
              return;
            }
            if (text[0] != '!' && 
                text[0] != '[' &&
                text.indexOf('(Adblock') != 0) {
              alert(translate("enterurloflist"));
              flash(translate("nolisturllabel"));
              return;
            }
            extension_call(
              "subscribe", 
              {id: id, text:text},
              function() {
                flash(translate("subscribedlabel"));
                if (then_reload) {
                  var myIndex = $("#tabpages").tabs("option", "selected");
                  $("#tabpages").tabs("load", myIndex);
                }
              }
            );
          },
          error: onError
        });
      }

      $(function() {
        extension_call('get_subscriptions_minus_text', {}, 
                                             function(subscriptions) {
          //sorting the list
          //1, 2: AB custom and easylist
          //3: additional easylist filters
          //4: other default filters
          //5: EasyPrivacy
          //6: custom filter lists
          var sorted_list = [];
          for (var id in subscriptions) {
            var entry = subscriptions[id];
            if (id == 'adblock_custom')
              entry.order = "1adblock_custom";
            else if (id == 'easylist')
              entry.order = "2easylist";
            else if (id == 'easyprivacy')
              entry.order = "5easyprivacy";
            else if (entry.user_submitted)
              entry.order = "6" +
                  (translate("filter" + id) || entry.name).toLowerCase();
            else if (entry.name.indexOf(" - additional ") == 0)
              entry.order = "3" +
                  (translate("filter" + id) || entry.name).toLowerCase();
            else
              entry.order = "4" +
                  (translate("filter" + id) || entry.name).toLowerCase();
            entry.id = id;
            entry.name = translate("filter" + id) || entry.name;
            sorted_list.push(entry);
          }
          sorted_list.sort(function(a,b) {
            return a.order > b.order ? 1 : (a.order == b.order ? 0 : -1);
          });

          // Build subscription checkboxes.
          for (var i = 0; i < sorted_list.length; i++) {
            var entry = sorted_list[i];
            var div = $("<div></div>").
              addClass("subscription");

            var checkbox = $('<input type="checkbox" />').
              attr("name", entry.id).
              attr("id", "subscription" + i);

            var name = $("<label>").
              text(entry.name).
              attr("title", entry.url).
              attr("for", "subscription" + i);

            var link_to_list = $("<a>", { target: "_new" }).
              text(translate('labelshow')).
              css("margin-left", "6px").
              css("font-size", "10px").
              css("display", "none").
              attr("class", "linkToList").
              attr("href", entry.url);
              
            var remove_filter_label = $("<a>").
              css("font-size", "10px").
              css("display", "none").
              attr("href", "#").
              text(translate("removefromlist")).
              addClass("remove_filter").
              click(function(event) {
                event.preventDefault();
                unsubscribe($(this).closest("div").children("input").attr("name"), true);
                $(this).closest("div").remove();
              });

            div.
              append(checkbox).
              append(name).
              append(link_to_list).
              append($("<span></span>").addClass("update_time")).
              append(remove_filter_label);

            $("#filter_subscriptions").
              append(div);
          }

          // Now that it's built, fill it in.
          refresh_subscription_view();

          // Each subscription checkbox, upon change, should subscribe
          // or unsubscribe the user and refresh the subscriptions.
          $('.subscription input:checkbox').change(function() {
            var checked = $(this).is(":checked");
            if (checked)
              $(this).closest("div").find(".remove_filter").css("display", "none");
              
            // If it changed in response to a model change event,
            // don't naively go tell the model about the event.
            if (global_refreshing_subscription_view) 
              return;
            
            var id = $(this).attr("name");
            if (!checked)
              unsubscribe(id, false);
            else
              subscribe(id);
          });

        });

        $("#btnUpdateNow").click(function() {
          $(this).attr("disabled", "disabled");
          extension_call("update_subscriptions_now", {});
          setTimeout(function() {
            $("#btnUpdateNow").removeAttr("disabled");
          }, 300000); //re-enable after 5 minutes
        });

        $("#btnNewSubscriptionUrl").click(function() {
          var url = $("#txtNewSubscriptionUrl").val();
          var abp_regex = /^abp.*location=(.*)$/;
          if (abp_regex.test(url)) {
            url = url.match(abp_regex)[1]; // the part after 'location='
            if (/&title/.test(url)) // then strip it
              url = url.substring(0, url.indexOf('&title'));
            url = unescape(url);
          }
          subscribe("url:" + url, true);
        });

        $('#txtNewSubscriptionUrl').keypress(function(event) {
          if (event.keyCode == '13') {
            event.preventDefault();
            $("#btnNewSubscriptionUrl").click();
          }
        });

        //translation
        localizePage();
      });
*/
  </script>
  
  <script>
    $(function() {
      var lists = generateSubscriptionInfo;
      
      /*var lists = {
        "russian": {
          url: subscriptions["russian"].url,
          name: subscriptions["russian"].name,
          language: "ru",
          requires: subscriptions["russian"].requiresList
        },
        "easylist_plus_spanish": {
          url: subscriptions["easylist_plus_spanish"].url,
          name: subscriptions["easylist_plus_spanish"].name,
          language: "es",
          requires: subscriptions["easylist_plus_spanish"].requiresList
        },
        "easylist_plus_french": {
          url: subscriptions["easylist_plus_french"].url,
          name: subscriptions["easylist_plus_french"].name,
          language: "fr",
          requires: subscriptions["easylist_plus_french"].requiresList
        },
        "easylist_plus_german": {
          url: subscriptions["easylist_plus_german"].url,
          name: subscriptions["easylist_plus_german"].name,
          language: "de",
          requires: subscriptions["easylist_plus_german"].requiresList
        },
        "italian": {
          url: subscriptions["italian"].url,
          name: subscriptions["italian"].name,
          language: "it",
          requires: subscriptions["italian"].requiresList
        },
        "japanese": {
          url: subscriptions["japanese"].url,
          name: subscriptions["japanese"].name,
          language: "ja",
          requires: subscriptions["japanese"].requiresList
        },
        "easylist_plun_korean": {
          url: subscriptions["easylist_plun_korean"].url,
          name: subscriptions["easylist_plun_korean"].name,
          language: "ko",
          requires: subscriptions["easylist_plun_korean"].requiresList
        },
        "dutch": {
          url: subscriptions["dutch"].url,
          name: subscriptions["dutch"].name,
          language: "nl",
          requires: subscriptions["dutch"].requiresList
        },
        "easylist_plus_polish": {
          url: subscriptions["easylist_plus_polish"].url,
          name: subscriptions["easylist_plus_polish"].name,
          language: "pl",
          requires: subscriptions["easylist_plus_polish"].requiresList
        },
        "chinese": {
          url: subscriptions["chinese"].url,
          name: subscriptions["chinese"].name,
          language: "zh",
          requires: subscriptions["chinese"].requiresList
        },
      };//TODO: ADD MORE*/
      
      var language = navigator.language.match(/^([a-z]+).*/i)[1];
      for (var list in lists) {
        // Set the language_specific list
        if (lists[list].language == language && language != "en")
          $("#easylist").after("<list id='" + list + "'></list>");
      }

      resetLanguageLists();
      resetPrivacyetceteraLists();
      resetCustomLists();
      createListDetails();

      // Set the properties of the language specific section
      function resetLanguageLists() {
        $("#new_language,#language").empty();
        $("#new_language").append("<option disabled='disabled'></option>");
        for (var list in lists) {
          if (lists[list].language == undefined || $("list#"+list).length != 0)
            return;
          if (lists[list].subscribed)
            $("#language").append("<list id='" + list + "'></list>");
          else
            $("#new_language").append("<option>" + lists[list].language + "</option>");
        }
      }
      // Set the properties of the section with privacy and other non-
      // adblocking lists
      function resetPrivacyetceteraLists() {
        $("#new_type,#privacyetcetera").empty();
        $("#new_type").append("<option disabled='disabled'></option>");
        for (var list in lists) {
          if (lists[list].type == undefined)
            return;
          if (lists[list].subscribed)
            $("#privacyetcetera").append("<list id='" + list + "'></list>");
          else
            $("#new_type").append("<option>" + lists[list].type + "</option>");
        }
      }
      // Set the properties of the section with custom lists
      function resetCustomLists() {
        $("#customlists").empty();
        for (var list in lists) {
          if (lists[list].type || lists[list].language || list == "adblock_custom")
            return;
          if (/url\:/.test(list))
            $("#customlists").append("<list id='" + list + "'></list>");
        }
      }
      // Fill all <list> entries with their checkboxes etcetera
      function createListDetails() {
        $("list[id]:empty").each(function() {
          var id = $(this).attr("id");
          var list = lists[id];

          var checkbox = $('<input type="checkbox" />').
            attr("id", "subscription" + id);

          var name = $("<label>").
            text(list.name).
            attr("title", list.url).
            attr("for", "subscription" + id);

          var link_to_list = $("<a>").
            attr("target", "_new").
            text(translate('labelshow')).
            addClass("linkToList").
            attr("href", list.url);
            
          var remove_filter_label = $("<a>").
            attr("href", "#").
            text(translate("removefromlist")).
            addClass("remove_filter").
            click(function(event) {
              //...
            });

          $(this).
            append(checkbox).
            append(name).
            append(link_to_list).
            append($("<span></span>").addClass("update_time")).
            append(remove_filter_label);
        });
        
        $(".listgroup:empty").html("<i>You are not subscribed to any lists in this section at the moment</i>");
      }
      // Return a list with all (possible) subscription data
      function generateSubscriptionInfo() {
        var bg = chrome.extension.getBackgroundPage();
        var lists = bg.utils.get_subscriptions_minus_text();
        // Add the language property to default language based lists
        lists.russian.language = "ru";
        lists.easylist_plus_spanish.language = "es";
        lists.easylist_plus_french.language = "fr";
        lists.easylist_plus_german.language = "de";
        lists.italian.language = "it";
        lists.japanese.language = "ja";
        lists.easylist_plun_korean.language = "ko";
        lists.dutch.language = "nl";
        lists.easylist_plus_polish.language = "pl";
        lists.chinese.language = "zh";
        lists.easylist.language = "en";
        // Add the type property to easylist
        lists.easyprivacy.type = "privacyprotection";
        // Add the other 28 subscriptions that were in the top 40
        // ...
        return lists;
      }
      
      // Translate the page
      localizePage();
    });
  </script>
  <div class="section">
    <h2 i18n="filterstabtitle"></h2>
    <p class="footnote" i18n="filterlistlink" i18n_replacement_el="footnotelink"></p>
    <a id="footnotelink" href="http://adblockplus.org/en/subscriptions" 
       target="_new"></a>
    <span i18n="updatenowmessage" i18n_replacement_el="btnUpdateNow"></span>
    <input type="button" id="btnUpdateNow" />
    <div id="subscriptionlist">
      <b>Recommended lists</b>
      <list id="adblock_custom"></list>
      <list id="easylist"></list>

      <b>Other ad blocking lists for languages</b>
      <div class="listgroup" id="language"></div>
      Select one here: <select id="new_language"></select>
      <select id="new_list_for_language"></select>
      <input type="button" id="add_new_language" i18n_value="subscribebutton" />

      <b>Lists intended for blocking other things than ads</b>
      <div class="listgroup" id="privacyetcetera"></div>
      Select one here: <select id="new_type"></select>
      <select id="new_list_for_type"></select>
      <input type="button" id="add_new_type" i18n_value="subscribebutton" />

      <b>My own personal favorites</b>
      <div class="listgroup" id="customlists"></div>
      Enter one here: <input id="new_custom" style="width:300px;" type="text" />
      <input type="button" id="add_new_custom" i18n_value="subscribebutton" />
    </div>
  </div>
  
  
  <div class="sneaky">
    <p>
    <span i18n="subscribetonone"></span>
    <input type="button" id="btnUnsubscribeAll" i18n_value="buttonok" />
    <br/>
    <span i18n="showlinkstolists"></span> 
    <input type="button" id="btnShowLinks" i18n_value="buttonok" />
    </p>
    <script>
      $(function() {
        $("#btnUnsubscribeAll").click(function() {
          $("input", ".subscription").each(function(i, el) {
            if (el.checked == true) {
              unsubscribe($(el).attr("name"));
            }
          });
        });

        $("#btnShowLinks").click(function() {
          $(".linkToList").css("display", "inline");
          $("#btnShowLinks").attr("disabled", "disabled");
        });
      });
    </script>
  </div>
