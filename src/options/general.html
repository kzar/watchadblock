  <script>
    $(function() {
      // Check or uncheck each loaded DOM option checkbox according to the 
      // user's saved settings.
      function load_options() {
        // Check or uncheck each option.
        for (var name in optionalSettings) {
          $("#enable_" + name).
            attr("checked", optionalSettings[name]);
        }
        $("input.feature:checkbox").change(function() {
          var is_enabled = $(this).is(':checked');
          var name = this.id.substring(7); // TODO: hack
          BGcall("set_setting", name, is_enabled);
        });
      }
      load_options();
    });
    rebuild_filters = function() {
      // Give the setting a sec to get saved by the other
      // change handler before recalculating filters.
      window.setTimeout(function() { 
        BGcall("update_filters");
      }, 1000);
    };
  </script>

  <div>
    <h2 i18n="generaloptions"></h2>

    <p>
      <input type="checkbox" class="feature" id="enable_show_google_search_text_ads"/>
      <label for="enable_show_google_search_text_ads" i18n="googletextads"></label>
    </p>
    <script>
      // TODO: This is a dumb race condition, and still has a bug where
      // if the user reloads/closes the options page within a second
      // of clicking this, the filters aren't rebuilt.  Call this inside
      // the feature change handler if it's this checkbox being clicked.
      $("#enable_show_google_search_text_ads").change(rebuild_filters);
    </script>

    <p>
      <input type="checkbox" class="feature" id="enable_show_context_menu_items" />
      <label for="enable_show_context_menu_items" i18n="showcontextmenus"></label>
    </p>

    <p>
      <input type="checkbox" class="feature" id="enable_block_youtube" />
      <label for="enable_block_youtube" i18n="youtubeads"></label>
      <span i18n="betalabel"></span>
    </p>

    <p>
      <input type="checkbox" class="feature" id="enable_blacklist_mode" />
      <label for="enable_blacklist_mode" i18n="blacklist_mode"></label><br/>
      <p id="blacklist_enabled" style="margin:-10px 0 0 20px;">
        <span class="footnote" i18n="blacklist_mode_exclude"></span><br/>
        <input id="blacklist_domains" style="margin-left:10px; font-size:10px; max-width:80%; width:640px;" i18n_title="multipledomainshint"/>
        <input type="button" id="save_blacklist" i18n_value="savebutton" disabled="disabled"/>
      </p>
      <script>
        $("#enable_blacklist_mode").change(function() {
          // Enable the text box when the option is enabled
          $("#blacklist_enabled").toggle(this.checked);
          rebuild_filters();
        });

        $("#blacklist_domains").bind("input", function() {
          // Enable the save button only when a valid filter can be generated
          var domainString = "~" + $(this).val().trim().
                           replace(/(\,\s?|\;\s?|\|\s?|\s)/g, "|~");
          try {
            FilterNormalizer.normalizeLine("*$domain=" + domainString);
            var isValid = true;
          } catch(ex) {
            var isValid = ($(this).val() == "");
          }
          $("#save_blacklist").attr("disabled", isValid ? null : "disabled");
        });

        $('#blacklist_domains').keypress(function(e) {
          // Pressing 'enter' is equal to pressing the save button
          if (e.keyCode == '13' && $("#save_blacklist").attr("disabled") == false) {
            e.preventDefault();
            $("#save_blacklist").click();
          }
        });

        $("#save_blacklist").click(function() {
          // Save the list with domains on a way that it can simply be appended
          // to '@@*$document' when the filters are generated.
          var domainString = ",domain=~" + $("#blacklist_domains").val().trim().
                             replace(/(\,\s?|\;\s?|\|\s?|\s)/g, "|~");
          if ($("#blacklist_domains").val().trim() == "")
            domainString = "";
          storage_set("blacklisted_domains", domainString);
          $(this).attr("disabled", "disabled");
          rebuild_filters();
        });

        $(function() {
          // Set the text when loaded
          $("#blacklist_enabled").toggle($("#enable_blacklist_mode").is(":checked"));
          var domainString = storage_get("blacklisted_domains") || "";
          domainString = domainString.replace(/\|~/g, ", ").replace(/^\,domain\=~/,"");
          $("#blacklist_domains").val(domainString);
        });
      </script>
    </p>

    <p>
      <input type="checkbox" class="feature" id="enable_show_advanced_options" />
      <label for="enable_show_advanced_options" i18n="advanced_options"></label>
      <script>
        $("#enable_show_advanced_options").change(function() {
          // Reload the page to show or hide the advanced options on the
          // options page -- after a moment so we have time to save the option.
          function waitASecThenReload() {
            window.setTimeout(function() {
              window.location.reload();
            }, 50);
          }
          if (!this.checked) // Make sure debugging wasn't left on by accident
            BGcall("set_setting", "debug_logging", false, waitASecThenReload);
          else
            waitASecThenReload();
        });
      </script>
    </p>

    <p class="advanced">
      <input type="checkbox" class="feature" id="enable_hide_instead_of_remove" />
      <label for="enable_hide_instead_of_remove" i18n="brokensite_beta_option"></label>
      <span i18n="betalabel"></span><br/>
      <span i18n="brokensite_beta_description" i18n_replacement_el="bugtracker" 
            class="footnote" style="display:none"></span>
      <a id="bugtracker" target="_blank" href="http://chromeadblock.com/bugs/?new"></a>
      <script>
        $("#enable_hide_instead_of_remove").
          change(function() {
            $('[i18n="brokensite_beta_description"]').toggle(this.checked);
          }).
          trigger("change");
      </script>
    </p>

    <p class="forDebug advanced">
      <input type="checkbox" class="feature" id="enable_debug_logging" />
      <label for="enable_debug_logging" i18n="debuginlogoption"></label>
    </p>
  </div>
