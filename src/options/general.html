  <script>
    $(function() {
      // Check or uncheck each loaded DOM option checkbox according to the 
      // user's saved settings.
      function load_options() {
        // Check or uncheck each option.
        for (var name in optionalSettings) {
          $("#enable_" + name).
            attr("checked", optionalSettings[name]);
        }
        $("input.feature:checkbox").change(function() {
          var is_enabled = $(this).is(':checked');
          var name = this.id.substring(7); // TODO: hack
          BGcall("set_setting", name, is_enabled);
        });
      }
      load_options();
    });
  </script>

  <div>
    <h2 i18n="generaloptions"></h2>

    <p>
      <input type="checkbox" class="feature" id="enable_show_google_search_text_ads"/>
      <label for="enable_show_google_search_text_ads" i18n="googletextads"></label>
    </p>
    <script>
      // TODO: This is a dumb race condition, and still has a bug where
      // if the user reloads/closes the options page within a second
      // of clicking this, the filters aren't rebuilt.  Call this inside
      // the feature change handler if it's this checkbox being clicked.
      $("#enable_show_google_search_text_ads").change(function() {
        // Give the setting a sec to get saved by the other
        // change handler before recalculating filters.
        window.setTimeout(function() { 
          BGcall("update_filters");
        }, 1000);
      });
    </script>

    <p class="chrome-only">
      <input type="checkbox" class="feature" id="enable_use_webrequest_blocking" />
      <label for="enable_use_webrequest_blocking" i18n="block_video_flash_ads"></label>
      <span i18n="betalabel"></span>
    </p>
    <div class="warning note" id="webrequest_warning" i18n="webrequest_warning"></div>
    <script>
      $(function() {
        $("#webrequest_warning").toggle($("#enable_use_webrequest_blocking").is(":checked"));
        $("#enable_use_webrequest_blocking").click(function() {
          $("#webrequest_warning").toggle(this.checked);
        });
      });
    </script>

    <p class="chrome-only">
      <input type="checkbox" class="feature" id="enable_popup_blocking" />
      <label for="enable_popup_blocking" i18n="block_popups"></label>
      <span i18n="betalabel"></span>
    </p>
    <div class="warning note" id="popup_warning" i18n="popup_warning"></div>
    <script>
      $(function() {
        if (SAFARI) return;
        hasWebNavigationPermission = false;
        chrome.permissions.contains({permissions: ['webNavigation']}, function(result) {
          hasWebNavigationPermission=result; // Sucks, but I have to do it this way.
          // Chrome requires you to call permissions.request from within a user gesture event.
          // Therefore I have to check this on beforehand...
        });
        $("#popup_warning").toggle($("#enable_popup_blocking").is(":checked"));
        $("#enable_popup_blocking").click(function() {
          $("#popup_warning").toggle(this.checked);
          if (!this.checked || hasWebNavigationPermission) return;
          chrome.permissions.request({permissions: ['webNavigation']}, function(granted) {
            if (!granted) { // User didn't allow the permission to be added
              $("#enable_popup_blocking").click().prop("checked", false);
            } else {
              // Cheating here. The background event has already fired, but at
              // that moment, the permission dialog wasn't accepted yet...
              BGcall("set_setting", "popup_blocking", true);
            }
          });
        });
      });
    </script>

    <p>
      <input type="checkbox" class="feature" id="enable_show_context_menu_items" />
      <label for="enable_show_context_menu_items" i18n="showcontextmenus"></label>
    </p>

    <p>
      <input type="checkbox" class="feature" id="enable_show_advanced_options" />
      <label for="enable_show_advanced_options" i18n="advanced_options"></label>
      <script>
        $("#enable_show_advanced_options").change(function() {
          // Reload the page to show or hide the advanced options on the
          // options page -- after a moment so we have time to save the option.
          // Also, disable all advanced options, so that non-advanced users will
          // not end up with debug/beta/test options enabled.
          if (!this.checked)
            $(".advanced :checkbox:checked").each(function() {
              BGcall("set_setting", this.id.substr(7), false);
            });
          window.setTimeout(function() {
            window.location.reload();
          }, 50);
        });
      </script>
    </p>

    <p class="forDebug advanced">
      <input type="checkbox" class="feature" id="enable_debug_logging" />
      <label for="enable_debug_logging" i18n="debuginlogoption"></label>
    </p>
  </div>
