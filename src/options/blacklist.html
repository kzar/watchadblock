  <script>
    register_broadcast_listener('user_filters_updated', function() {
      extension_call('get_user_filters', {}, display_user_filters);
    });

    function display_user_filters(filters) {
      var view = $("#user_filters");

      var table = $("<table></table>").
        addClass("entry_table");
      view.html(table);
      table.append("<tr>" +
        "<th>Block ads that match this CSS selector...</th>" +
        "<th>on domains that match this regex</th>" +
        "</tr>");
      $.each(filters, function(i, filter) {
        var cell1 = $("<td>").text(filter.css_regex);
        var cell2 = $("<td>").text(filter.domain_regex);
        var cell3 = $('<a href="#"></a>').
          text("Unblock").
          click(function(event) {
            event.preventDefault();
            extension_call('remove_user_filter', {filter:filter});
          });
        var cell4 = $('<a href="#"></a>').
          css("margin-left", "4px").
          text("Edit").
          click(function(event) {
            event.preventDefault();
            // Make a global variable that will be consumed when the
            // filters are redrawn
            blacklist_edit_entry = filter;
            extension_call('remove_user_filter', {filter:filter});
          });
        var row = $("<tr></tr>").
          append(cell1).
          append(cell2).
          append(cell3).
          append(cell4).
          appendTo(table);
      });

      var cell1 = $("<td><input id='txtUserFilterCss' /></td>");
      var cell2 = $("<td><input id='txtUserFilterDomain' /></td>");
      var cell3 = $("<input/>", {
        type:"button", 
        id:"btnAddUserFilter", 
        value:"Block it!",
        disabled: "disabled",
        style: "height: 22px; margin-top:2px;",
        click: function() {
          var css_regex = $("#txtUserFilterCss").val();
          var domain_regex = $("#txtUserFilterDomain").val();
          if (domain_regex == "" || domain_regex == "*")
            domain_regex = ".*";
          if (css_regex.indexOf("##") != -1) {
            // The user misunderstood a bug report and thought they
            // were to add a filter themselves that was in easylist
            // format.
            var parts = css_regex.split("##");
            css_regex = (parts[1] == null || parts[1] == '') ? '*' : parts[1];
            domain_regex = (parts[0] == '' || parts[0] == '*') ? '.*' : parts[0];
          }

          extension_call(
            'add_user_filter', 
            {
              filter: {
                domain_regex: domain_regex,
                css_regex: css_regex
              }
            }
          );
          $("#txtUserFilterCss").val("");
          $("#txtUserFilterDomain").val("");
        }
      });

      $("<tr></tr>").
        append(cell1).
        append(cell2).
        append(cell3).
        appendTo(table);

        table.append("<tr><td colspan=2 class='plain'><a id='btnUserFilterExamples' href='#'>Help!</a></td></tr>");
      $("#btnUserFilterExamples").click(function(event) {
        event.preventDefault();
        $("#user_filter_help").show();
        $(this).remove();
      });

      var check_for_valid_filter = function() {
        var css_regex = $("#txtUserFilterCss").val();
        var domain_regex = $("#txtUserFilterDomain").val();
        var ok = true;
        var test_domain_regex = (css_regex.indexOf('##') >= 0)
            ? css_regex.substring(0, css_regex.indexOf('##'))
            : domain_regex;
          if (test_domain_regex != "*" &&
              test_domain_regex != "" && 
              test_domain_regex.indexOf(".") == -1)
            ok = false;
        if (ok) {
          //note: this doesn't check the content of the :not( ) selector
          //as that would almost double the size of the regex...
          //TODO: add a valid 'domain name regex'-regex, but wait for
          //issue 267 to be fixed first. Until this time any
          //user adding a filter containing multiple '##' will get
          //a broken filter
          //When you modify this regex, also modify the one in blacklistui.js
          var validate_regex = /(\#\#|^)((((\*|[A-Za-z0-9]+)|(\*|[A-Za-z0-9]+)?(((\[([a-zA-Z0-9\-]+)((\~|\^|\$|\*|\|)?\=\".+\")?\])+)|((\:(root|nth(\-last)?\-child\(((\d+)|odd|even)\)|nth(\-last)?\-of\-type\(((\d+)|odd|even)\)|(first|last|only)\-child|(first|last|only)\-of\-type|empty|link|visited|active|hover|focus|target|(contains|not)\(.+\)|lang\([a-zA-Z\-]+\)|(en|dis)abled|checked|\:(first\-(line|letter)|before|after|selection)))+)|\.[^\#]+|\#[a-zA-Z0-9_\-\:\.]+)))+(\ ?)+((\>|\+|\~)(\ ?)+)?)+$/;
          ok = validate_regex.test(css_regex);
        }
        $("#btnAddUserFilter").attr("disabled", ok ? null : "disabled");
      }
      $("#txtUserFilterCss").keyup(check_for_valid_filter);
      $("#txtUserFilterDomain").keyup(check_for_valid_filter);
    
      $('#txtUserFilterCss, #txtUserFilterDomain').keypress(function(event) {
        if (event.keyCode == '13' && $("#btnAddUserFilter").attr("disabled") == false) {
          event.preventDefault();
          $("#btnAddUserFilter").click();
        }
      });

      //Put filters from 'edit' in the textboxes
      if (typeof blacklist_edit_entry != "undefined") {
        if (blacklist_edit_entry.css_regex.length > 0) {
          $('#txtUserFilterCss').val(blacklist_edit_entry.css_regex);
          $('#txtUserFilterDomain').val(blacklist_edit_entry.domain_regex);
          check_for_valid_filter();
        }
        delete blacklist_edit_entry; // remove global variable
      }
    }

    $(document).ready(function() {
      extension_call('get_user_filters', {}, display_user_filters);

      load_options();
    });

      $('.optionDescription').click(function() {
        $(this).prev('input').
          click().
          change();
      });
  </script>

  <a name="user_filters_link"></a>
  <div class="section">
    <h2>Block an ad that the filters missed</h2>
    <div id="user_filters"></div>

    <div id="user_filter_help" style="display:none">
      <p>Remember -- you can always just 
      <a href="http://code.google.com/p/adblockforchrome/issues/entry?template=Ad%20report%20from%20user" target="_new">report the ad to us</a>,
      and your report will result in a fix for yourself and for 
      over a hundred thousand other users!</p>

      <table class="help_table">
        <tr>
          <th>Sample CSS selectors</th>
          <th>What they match</th>
        </tr>
        <tr>
          <td>div[class="ad"]</td>
          <td>any div whose class is "ad"</td>
        </tr>
        <tr>
          <td>table td img[class^="Ad"][id="bigAd"]</td>
          <td>any img (within tds within tables) whose class starts 
            with "Ad" and whose id is "bigAd"</td>
        </tr>
        <tr>
          <td>iframe[name$="AdFrame"][src*="ads.com"]:last-child</td>
          <td>any iframe whose name ends with "AdFrame" <br/>and whose src 
            contains "ads.com" and who is the last element in its 
            parent node</td>
        </tr>
        <tr>
          <th>Sample domain regexes</th>
          <th>What they match</th>
        </tr>
        <tr>
          <td>.*</td>
          <td>any domain</td>
        </tr>
        <tr>
          <td>mail..*.com</td>
          <td>any domain containing "mail." and ".com" in that order</td>
        </tr>
        <tr>
          <td>mail.google.com</td>
          <td>any domain containing "mail.google.com"</td>
        </tr>
        <tr>
          <td>^mail.google.com$</td>
          <td>any domain exactly matching "mail.google.com"</td>
        </tr>
      </table>
    </div>

    <p class="note">
      Got a particularly useful filter?  Why not 
      <a href="http://code.google.com/p/adblockforchrome/issues/entry?template=Ad%20report%20from%20user" target="_new">share it with us</a>,
      so we can give it to all AdBlock users?
    </p>

    <b>Shortcut:</b> Press <b>Ctrl-Shift-K</b> (think "Kill!") on a page 
    to block an ad.  <span style="font-size:smaller">(If you don't see 
    anything happen, try clicking on the page first.)</span>
    <input style="margin-left: 15px" type="checkbox" class="feature" 
           id="enable_blacklist_shortcut" />
    <span class="optionDescription">Shortcut enabled</span>
  </div>
