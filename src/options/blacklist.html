  <style>
    .addControls {
      margin-left: 20px;
    }
    .entryTable {
      font-size: 12px;
      margin-top: 5px;
    }
    .entryTable input[type="button"] {
      height: 22px;
    }
    .guide {
      font-style: italic;
      color: grey;
    }
  </style>

  <script>
    register_broadcast_listener('filters_updated', function() {
      extension_call('get_custom_filters_text', {}, function(filters) {
        if ($("#txtFiltersAdvanced").attr("disabled") == false)
          return;
        $("#txtFiltersAdvanced").val(filters);
      });
    });

    $(function() {

      function appendCustomFilter(filter) {
        var customFilterText = $("#txtFiltersAdvanced").val();
        $("#txtFiltersAdvanced").val(filter + "\n" + customFilterText);
        saveFilters();
      }

      $("#txtUserFilterCss").val('div[class*="exampleClass"][id="someBigAd"]');
      $("#txtUserFilterDomain").val('*');

      $("#txtBlockUrl").val(".com/flashAd");
      $("#txtBlockUrlDomain").val("*");

      $("#btnAddUserFilter").click(function() {
        var blockCss = $("#txtUserFilterCss").val().trim();
        var blockDomain = $("#txtUserFilterDomain").val().trim();

        if (blockDomain == '.*' || blockDomain == "*" || blockDomain == '')
          appendCustomFilter("##" + blockCss);
        else
          appendCustomFilter(blockDomain + "##" + blockCss);

        $(this).closest(".entryTable").find("input:text").val("");
        $(this).attr("disabled", "disabled");
      });

      $("#btnAddUrlBlock").click(function() {
        var blockUrl = $("#txtBlockUrl").val().trim();
        var blockDomain = $("#txtBlockUrlDomain").val().trim();
        if (blockDomain == '*')
          blockDomain = '';

        if (blockDomain == '')
          appendCustomFilter(blockUrl);
        else
          appendCustomFilter(blockUrl + "$domain=" + blockDomain);

        $(this).closest(".entryTable").find("input:text").val("");
        $(this).attr("disabled", "disabled");
      });

      function validateDomain(domain) {
        if (domain == '') return true;
        var domain_validation_regex = /^(([a-zA-Z0-9\-]+\.)+[0-9a-zA-Z]{1,6})|[a-zA-Z0-9\-\.]*\*[a-zA-Z0-9\-\.\*]*$/;
        if (!domain_validation_regex.test(domain)) return false;
        if (domain.indexOf('..') > -1) return false;
        if (domain.indexOf('**') > -1) return false;
        return true;
      }

      var validateUrlFilter = function() {
        var blockUrl = $("#txtBlockUrl").val().trim();
        var blockDomain = $("#txtBlockUrlDomain").val().trim();
        if (blockDomain == '*')
          blockDomain = '';

        var ok = true;
        if (!validateDomain(blockDomain))
          ok = false;
        if (blockUrl == '')
          ok = false;
        $("#btnAddUrlBlock").attr("disabled", ok ? null : "disabled");
      }
      $("#divUrlBlock input:text").keyup(validateUrlFilter);

      var validateCssFilter = function() {
        var blockCss = $("#txtUserFilterCss").val().trim();
        var blockDomain = $("#txtUserFilterDomain").val().trim();
        var ok = true;
        if (!validateDomain(blockDomain))
          ok = false;
        if (ok) {
          ok = global_filter_validation_regex.test(blockCss);
        }
        $("#btnAddUserFilter").attr("disabled", ok ? null : "disabled");
      }
      $("#divCssBlock input:text").keyup(validateCssFilter);

      $('.entryTable input:text').keypress(function(event) {
        var submitButton = $(this).closest(".entryTable").find(":button");
        if (event.keyCode == '13' && submitButton.attr("disabled") == false) {
          event.preventDefault();
          submitButton.click();
        }
      });

      $("a.controlsLink").click(function() {
        event.preventDefault();
        var myControls = $(this).closest("div").find(".addControls");
        $(".addControls").not(myControls).slideUp();
        myControls.slideDown();
        $('input:text:not([id*="Domain"])', myControls).select();
      });

      $("#btnEditAdvancedFilters").click(function() {
        $("#divAddNewFilter").slideUp();
        $(".addControls").slideUp();
        $("#txtFiltersAdvanced").attr("disabled", null);
        $("#divSaveButton").slideDown();
        $("#btnEditAdvancedFilters").hide();
        $("#txtFiltersAdvanced").focus();
      });

      function saveFilters() {
        var text = $("#txtFiltersAdvanced").val();
        extension_call("set_custom_filters_text", { filters: text });

        $("#divAddNewFilter").slideDown();
        $("#txtFiltersAdvanced").attr("disabled", "disabled");
        $("#divSaveButton").slideUp();
        $("#btnEditAdvancedFilters").show();
      }
      $("#btnSaveAdvancedFilters").click(saveFilters);
      
      extension_call('get_custom_filters_text', {}, function(text) {
        $("#txtFiltersAdvanced").val(text);
      });
    });

    $(document).ready(function() {
      load_options();
    });
  </script>

  <div class="section">
    <h2 i18n="blacklisttabtitle"></h2>

    <div>
      <span id="blacklistshortcut"></span>
      <input style="margin-left: 15px" type="checkbox" class="feature" 
             id="enable_blacklist_shortcut" />
      <span class="optionDescription" i18n="shortcutenabled"></span>
    </div>

    <div>

      <div id="divAddNewFilter">
        <h3 i18n="addnewfilter"></h3>

        <div>
          <a class="controlsLink" id="aUrlBlock" href="#" i18n="linkblockadbyrul"></a>
          <div id="divUrlBlock" class="addControls" style="display:none">
            <table class="entryTable">
              <tr>
                <td i18n="blockurlwithtext"></td>
                <td></td>
                <td i18n="blockdomain"></td>
              </tr>
              <tr>
              </tr>
              <tr>
                <td><input id="txtBlockUrl" style="width:300px"/></td>
                <td class="guide">$domain=</td>
                <td><input id="txtBlockUrlDomain"/></td>
                <td><input id="btnAddUrlBlock" type="button"/></td>
              </tr>
            </table>
          </div>
        </div>

        <div>
          <a class="controlsLink" id="aCssBlock" href="#" i18n="linkhidesection"></a>
          <div id="divCssBlock" class="addControls" style="display:none">
            <table class="entryTable">
              <tr>
                <td i18n="blockdomain"></td>
                <td></td>
                <td i18n="csstomatch"></td>
              </tr>
              <tr>
              </tr>
              <tr>
                <td><input id="txtUserFilterDomain" style="width:200px"/></td>
                <td class="guide">##</td>
                <td><input id="txtUserFilterCss" style="width:300px"/></td>
                <td><input id="btnAddUserFilter" type="button"/></td>
              </tr>
            </table>
          </div>
        </div>

      </div>

      <h3 i18n="manualfilteredit"></h3>
      <div>
        <input type="button" id="btnEditAdvancedFilters" />
        <div id="divSaveButton" style="display:none">
          <p class="footnote">
            <span i18n="brokenfilterbreakingfilters"></span><br/>
            <span id="tutorial"></span>
          </p>
          <input type="button" id="btnSaveAdvancedFilters" />
          <span id="lblSaveWarning" style="color:red;margin-left:20px">
            <b i18n="savereminder"></b>
          </span>
        </div>
      </div>

    </div>

    <div>
      <textarea id="txtFiltersAdvanced" cols="112" rows="15" style="font-size:12px;" disabled></textarea>
      <br/>
    </div>

  </div>
  <script type="text/javascript">
    //translation
    $("[i18n]").each(function() {
      $(this).text(translate($(this).attr("i18n")));
    });
    $("#blacklistshortcut").html(translate("blacklistshortcutmessage", 
        ['<b>', '</b>', '<b>Ctrl-Shift-K</b>', '<span style="font-size:smaller">',
        '</span>']));
    $("#btnAddUserFilter, #btnAddUrlBlock").
        attr("value", translate("buttonblockit"));
    $("#btnEditAdvancedFilters").attr("value", translate("buttonedit"));
    $("#tutorial").html(translate("filtertutorial", 
        ['<a href="http://adblockplus.org/en/filters" target="_new">',
        '</a>']));
    $("#btnSaveAdvancedFilters").attr('value', translate("savebutton"));

    //clicking the checkbox label checks the checkbox
    $('.optionDescription').click(checkboxlabel_clicked);
  </script>