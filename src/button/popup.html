<!DOCTYPE HTML>
<html>
  <head>
    <link rel="stylesheet" href="popup.css"/>
    <link rel="stylesheet" href="../jquery/css/custom-theme/jquery-ui-1.8.custom.css"/>
    <script src="../jquery/jquery-1.4.2.min.js"></script>
    <script src="../jquery/jquery-ui-1.8.custom.min.js"></script>
    <script src="../functions.js"></script>
    <script>
      // Show each DOM id in the list.
      function show(list) {
        for (var i = 0; i < list.length; i++) {
          $("#" + list[i]).show();
        }
      }

      // Hide each DOM id in the list.
      function hide(list) {
        for (var i = 0; i < list.length; i++) {
          $("#" + list[i]).hide();
        }
      }

      // Set the domain name throughout the popup, ellipsifying if necessary.
      function setDomain(name) {
        if (name.length > 25) {
          name = name.substring(0, 17) + "..." +
              name.substring(name.length - 5);
        }
        $(".domainspan").text(name);
      }

      // Set menu entries appropriately for the selected tab.
      function customize_for_this_tab() {
        var menu_items = [
          "div_pause_adblock",
          "div_unpause_adblock",
          "div_blacklist",
          "div_whitelist",
          "div_whitelisted",
          "separator1",
          "div_options",
          "div_help_disable",
        ];
        hide(menu_items);

        getCurrentTabInfo(function(info) {
          if (localStorage.getItem('adblock_is_paused')) {
            show(["div_unpause_adblock", "separator1", "div_options"]);
          } else if (info.disabled_site) {
            show(["div_options", "div_help_disable"]);
          } else if (info.whitelisted) {
            show(["div_pause_adblock", "div_whitelisted", "separator1", "div_options", "div_help_disable"]);
          } else {
            show(["div_pause_adblock", "div_blacklist", "div_whitelist", "separator1", "div_options", "div_help_disable"]);
          }
          setDomain(info.domain);
        });
      }

      $(function() {
        customize_for_this_tab();
      });
    </script>
  </head>
  <body>
    <div class="wrapper">

      <div id="titletext">AdBlock</div>
      <script>
        $("#titletext").click(function() {
          var url = "https://chrome.google.com/extensions/detail/" +
              adblock_extension_id;
          chrome.tabs.create({url:url});
        });
      </script>


      <div id="div_pause_adblock" class="menu-entry">
        Pause AdBlock
      </div>
      <script>
        $("#div_pause_adblock").click(function() {
          localStorage.setItem('adblock_is_paused', true);
          chrome.extension.getBackgroundPage().updateButtonUI();
          chrome.contextMenus.removeAll();
          window.close();
        });
      </script>


      <div id="div_unpause_adblock" class="menu-entry">
        Unpause AdBlock
      </div>
      <script>
        $("#div_unpause_adblock").click(function() {
          localStorage.removeItem('adblock_is_paused');
          chrome.extension.getBackgroundPage().updateButtonUI();
          chrome.extension.getBackgroundPage().utils.addChromeContextMenus();
          window.close();
        });
      </script>


      <div id="div_blacklist" class="menu-entry">
        Block an ad on this page
      </div>
      <script>
        $("#div_blacklist").click(function() {
          getCurrentTabInfo(function(info) {
            extension_call(
              'open_blacklist_ui_on_tab',
              {tabid:info.tab.id},
              function() { window.close(); }
            );
          });
        });
      </script>


      <div id="div_whitelist" class="menu-entry">
        Don't run on <span class="domainspan">this site</span>
      </div>
      <script>
        $("#div_whitelist").click(function() {
          getCurrentTabInfo(function(info) {
            extension_call("add_to_whitelist", {domain:info.domain}, function() {
              // Reload the tab
              chrome.tabs.update(info.tab.id, {url: info.tab.url});
              window.close();
            });
          })
        });
      </script>


      <div id="div_whitelisted" style="display:none" class="menu-entry">
        Block ads on <span class="domainspan">this site</span>
      </div>
      <script>
        $("#div_whitelisted").click(function() {
          getCurrentTabInfo(function(info) {
            extension_call("remove_from_whitelist", {domain:info.domain}, 
                         function() {
              // Reload the tab
              chrome.tabs.update(info.tab.id, {url: info.tab.url});
              window.close();
            });
          })
        });
      </script>


      <div id="separator1" class="separator"></div>

      <div id="div_options" class="menu-entry">
        Options
      </div>
      <script>
        $("#div_options").click(function() {
          chrome.tabs.create({url:chrome.extension.getURL("options/index.html")});
        });
      </script>

      <div id="div_help_disable">
        <div class="menu-entry">
          Don't show this button
        </div>
        <div id="help_disable_explanation" class="info" style="display:none">
          <p>
            To hide this button, drag it to the right edge of your extension
            buttons, then click just to the right of the address bar and
            drag to the right.
          </p>
        </div>
      </div>
      <script>
        $("#div_help_disable").click(function() {
          $("#help_disable_explanation").slideDown();
        });
      </script>

      <div class="separator"></div>
      <div id="div_donate">
        <div id="please" style="text-decoration: underline; color: blue">Please donate!</div>
        <div id="donation_wrapper" style="display:none;">
          <div id="donation_panel">
            I'd love to do this work full time, and donations would help me get there.
            <hr/>
            <div>
              <span>Donate</span>
              $<input id="donation_amount" maxlength="5" value="30"/>
              <br/>
              <div id="donate_slider"></div>
            </div>
            <br/>
            <div>
              And add a note
              <span style="font-size:x-small">(a donation with a note makes my day!)</span><br/>
              <input type="text" id="donate_note" maxlength=200 style="width:250px" /><br/>
            <table>
              <tr>
                <td><input type="button" style="font-weight: bold; font-size:large" value="Donate" id="btnDonate"/></td>
                <td><span id="donation_measure"></span></td>
              </tr>
            </table>
          </div>
        </div>
      </div>
      <script>
        function update_measure() {
          var amt = $("#donation_amount").val();
          var msgs = {
            10: "Thanks!",
            25: "I could pay my water bill with this!",
            30: "I would really appreciate this!",
            50: "This would buy my wife and me a nice dinner!",
            75: "I could pay my phone bill with this!",
            100: "You're helping me earn a living!",
            150: "Wow!  Thank you so much!",
            200: "You are amazing!"
          };
          var scores = {}
          for (var size in msgs) {
            scores[size] = amt - size;
          }
          best = 10000;
          for (var size in scores) {
            if (scores[size] < best && scores[size] >= 0) {
              best = scores[size];
              answer = size;
            }
          }
          $("#donation_measure").text(msgs[answer]);
        }
        $(function() {
          slid = false;
          $("#div_donate").mouseenter(function() { 
            if (slid) return;
            slid = true;
            $("#donation_wrapper").slideDown();
            $("body, #donation_wrapper").animate({width: "+=100"}, {queue: false});
          });
          $("#donate_slider").width(200).slider({
            min: 10,
            max: 200,
            range: "min",
            value: $("#donation_amount").val(),
            step: 5,
            slide: function(event, ui) {
              $("#donation_amount").val(ui.value);
              update_measure();
            }
          });
          $("#donation_amount").
            width(35).
            keyup(function() { 
              $("#donate_slider").slider("value", this.value); 
              update_measure();
            });
          $("#btnDonate").click(function() {
            var amt = $("#donation_amount").val().trimLeft().trimRight();
            if (!amt.match(/^[1-9]*(\.?)[0-9]+$/))
              return;
              var url = "https://www.paypal.com/cgi-bin/webscr?form=_xclick&cmd=_donations&business=gundlach.business@gmail.com&currency_code=USD&item_name=AdBlock%20for%20Chrome&no_note=1";
            if ($("#donate_note").val() != "")
              url += "&on0=msg&os0=" + escape($("#donate_note").val());
            url += "&amount=" + amt;
            // TODO: add an &image_url=[150x50 logo]
            chrome.tabs.create({url: url});
            window.close();
          });
          update_measure();
        });
      </script>


    </div>
  </body>
</html>
