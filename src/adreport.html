<!--
   URL:
   chrome-extension://gighmmpiobklfepjocnamgkkbiglidom/adreport.html
   ?from=[options|blacklister]
   &url={domain_href}
   &suggested={suggestedfilter}
-->
<html>
  <head>
    <title>AdBlock - Reporting an ad</title>
    <link rel="stylesheet" href="options/options.css" />
    <script src="port.js" type="text/javascript"></script>
    <script src="jquery/jquery-1.4.2.min.js" type="text/javascript"></script>
    <script src="functions.js" type="text/javascript"></script>
    <style type="text/css">
      .icon {
        background-image:url('img/icon32.png')
      }
      .section h2 {
        font-size: 1.2em;
        margin-left: 10px;
      }
      .optionDescription {
        margin-right: 15px;
      }
      div.form {
        margin-left: 15px;
      }
      #whattodo {
        font-weight: bold;
        color: red;
        font-size: 15px;
        margin: 20px;
      }
      .answer {
        color: blue;
        font-weight: bold;
      }
      .section {
        display:none;
      }
    </style>
    <script type="text/javascript">
      //fetching the options...
      var options = [];
      var search = location.search.substring(1).split('&');
      for (var item in search) {
        if (search[item].indexOf('=') == -1) continue;
        options[search[item].split('=')[0]] = 
                         unescape(search[item].split('=')[1]);
      }

      //get the list of subscribed filters and
      //all unsubscribed default filters
      var unsubscribed_default_filters = [];
      var subscribed_filter_names = [];
      extension_call("get_subscriptions_minus_text", {}, function(subs) {
        for (var id in subs)
          if (!subs[id].subscribed && !subs[id].user_submitted)
            unsubscribed_default_filters[id] = subs[id];
          else if (subs[id].subscribed)
            subscribed_filter_names.push(subs[id].name);
      });

      //generate the URL to the issue tracker
      function generateReportURL() {
        var domain = "";
        if (options['url']) {
          domain = options['url'].substring(options['url'].indexOf("://")+3);
          domain = domain.substring(0, domain.indexOf('/'));
        }
        var result = "http://code.google.com/p/adblockforchrome/issues/entry" +
                     "?template=Ad%20report%20from%20user&summary="
        if (domain) 
          result = result + escape("Ad report: " + domain);
        else
          result = result + escape("Ad report at <enter URL of webpage here>");

        var body = [];
        body.push("Last step -- point me to the ad so I can fix the bug!  " +
            "Don't leave anything out or I'll probably " +
            "have to ignore your report.  Thanks!");
        body.push("");
        if (!options['url']) {
          body.push("1. Paste the URL of the webpage showing an ad: ");
          body.push("");
          body.push("");
        }
        body.push("2. Exactly where on that page is the ad?  What does it " +
            "look like?  Attach a screenshot, with the ad clearly marked, " +
            "if you can.");
        body.push("");
        body.push("");
        if (!options['suggested']) {
          body.push("3. Paste a working filter, if you have one: ");
          body.push("");
          body.push("");
        }
        body.push("4. Any other information that would be helpful, besides " +
            "what is listed below: ");
        body.push("");
        body.push("");
        body.push("-------- Please don't touch below this line. ---------");
        if (options['url']) {
          body.push("=== URL with ad ===");
          body.push(options['url']);
          body.push("");
        }
        body.push("=== Subscribed filters ===");
        body.push(subscribed_filter_names.join('\n'));
        body.push("");
        body.push("=== Browser" + (AdBlockVersion ? ' & AdBlock' : '') + ": ===");
        body.push(SAFARI ? "Safari " :
          "Google Chrome " + navigator.userAgent.match('Chrome\/([0-9.]+)')[1]);
        if (AdBlockVersion) 
          body.push("AdBlock " + AdBlockVersion);
        if (options['suggested']) {
          body.push("");
          body.push("=== The selector created by the user ===");
          body.push(options['suggested']);
        }

        result = result + "&comment=" + escape(body.join('\n'));

        return result;
      }
    </script>
  </head>
  <body>
    <h1 class="icon">AdBlock</h1>


    <!--STEP 0-->
    <div style="padding-left:5px; margin-bottom:20px">
      So you just found an ad on a web page? Well, I'll help you to find the
      correct place to report it!<br/>
      Remember: reporting ads is voluntary. If you don't wish to do this you
      can just close this window and block it only for yourself by 
      adding its filter in the 'Blacklister' tab of the options page!
    </div>

    <!--STEP 1-->
    <div class="section" id="step1DIV" style="display:block;">
      <h2>Make sure your filter lists are up to date</h2>
      <ol>
        <li>Click this button: <input type="button" value="Update my filters!" id="UpdateFilters" />
        <li>Reload the page with the ad.
      </ol>
      Does the ad still appear?<br/>
      <div id="step1" class="form">
        <input type="radio" id="step1_yes" name="step1"/>
        <span class="optionDescription">Yes</span>
        <input type="radio" id="step1_no" name="step1" />
        <span class="optionDescription">No</span>
      </div>
    </div>
    <script type="text/javascript">
      //Updating the users filters
      $("#UpdateFilters").click(function() {
        $(this).attr("disabled", "disabled");
        extension_call("update_subscriptions_now", {});
      });
      //if the user clicks a radio button
      $("#step1_no").click(function() {
        $("#step1").html("<span class='answer'>No</span>");
        $("#whattodo").text(
                 "You don't have to do anything as the ad is already blocked");
      });
      $("#step1_yes").click(function() {
        $("#step1").html("<span class='answer'>Yes</span>");
        $("#step2DIV").css("display", "block");
      });
    </script>
    
    
    <!--STEP 2-->
    <div class="section" id="step2DIV">
      <h2>Correct filters</h2>
      In what language is that page written?
      <div id="step2" class="form">
        <select id="step2_lang">
          <option disabled="disabled"></option>
          <option value="easylist;http://forums.lanik.us/">English</option>
          <option value="easylist;easylist_plus_bulgarian;mailto:alex at stanev.org">Bulgarian</option>
          <option value="chinese;http://code.google.com/p/adblock-chinalist/issues/list">Chinese</option>
          <option value="czech;">Czech</option>
          <option value="danish;mailto:henrik at schack.dk">Danish</option>
          <option value="easylist;dutch;http://code.google.com/p/dutchadblockfilters/issues/list">Dutch</option>
          <option value="easylist;easylist_plus_finnish;http://www.wiltteri.net/?page_id=157/wiltteri-lista/">Finnish</option>
          <option value="easylist;easylist_plus_french;http://forums.lanik.us/viewforum.php?f=91">French</option>
          <option value="easylist;easylist_plus_german;http://forums.lanik.us/viewforum.php?f=90">German</option>
          <option value="hungarian;mailto:pete at teamlupus.hu">Hungarian</option>
          <option value="israeli;http://code.google.com/p/israellist/issues/list">Israeli</option>
          <option value="italian;mailto:giovanni at gfsolone.com">Italian</option>
          <option value="japanese;mailto:mp3geek at gmail.com">Japanese</option>
          <option value="easylist_plun_korean;http://corset.tistory.com/guestbook">Korean</option>
          <option value="easylist;easylist_plus_norwegian;mailto:mlan76 at gmail.com">Norwegian</option>
          <option value="easylist;easylist_plus_polish;polish;mailto:admin at adblocklist.org">Polish</option>
          <option value="easylist;easylist_plus_romanian;mailto:menetz at gmail.com">Romanian</option>
          <option value="russian;http://forum.mozilla-russia.org/viewtopic.php?id=3679">Russian</option>
          <option value="easylist_plus_spanish;mailto:nauscopio at gmail.com">Spanish</option>
          <option value="ukranian;mailto:adblock.ua at gmail.com">Ukranian</option>
          <option value="easylist;easylist_plus_vietnamese;http://code.google.com/p/adblockplus-vietnam/issues/list">Vietnamese</option>
          <option value="easylist;http://forums.lanik.us/">Other</option>
        </select>
      </div>
    </div>
    <script type="text/javascript">
      //if the user clicks an item
      var contact = "";
      $("#step2_lang").change(function() {
        var selected = $("#step2_lang option:selected");
        $("#step2").html("<span class='answer'>"+ selected.text() +"</span>");
        var required_lists = selected.attr('value').split(';');
        for (var i=0; i < required_lists.length-1; i++) {
          if (unsubscribed_default_filters[required_lists[i]]) {
            $("#whattodo").text(
                       "Subscribe to this filter list, then try again: " +
                         unsubscribed_default_filters[required_lists[i]].name);
            return;
          }
        }
        contact = required_lists[required_lists.length-1];
        $("#step3DIV").css("display", "block");
      });
    </script>
    
    
    <!--STEP 3-->
    <div class="section" id="step3DIV">
      <h2>Check in Firefox</h2>
      <ol>
        <li>Install Firefox if you don't have it.
        <li>Install Adblock Plus for Firefox if you don't have it.
        <li>In Firefox, subscribe to the same filter lists as you have here (except AdBlock Custom filters).
        <li>In Firefox, load the page with the ad.
      </ol>
      Does the ad appear in Firefox?
      <div class="form" id="step3">
        <input type="radio" id="step3_yes" name="step3"/>
        <span class="optionDescription">Yes</span>
        <input type="radio" id="step3_no" name="step3" />
        <span class="optionDescription">No</span>
        <input type="radio" id="step3_wontcheck" name="step3" />
        <span class="optionDescription">I don't want to check this</span>
      </div>
    </div>
    <script type="text/javascript">
      //If the user clicks a radio button
      $("#step3_yes").click(function() {
        $("#step3").html("<span class='answer'>Yes</span>");
        if (contact.indexOf('mailto:') == 0)
          contact = contact.replace(" at ", "@").substring(7);
        $("#whattodo").html("This is a filter list problem.  Report it here: " +
          "<a href='" + contact + "'>" + contact + "</a>");
      });
      $("#step3_no").click(function() {
        $("#step3").html("<span class='answer'>No</span>");
        $("#whattodo").html("You can report the ad to us <a href='" +
          generateReportURL() + "'>in the issue tracker</a>.  (We are already aware that we can't block ads in most videos; we're waiting on support in WebKit.)");
      });
      $("#step3_wontcheck").click(function() {
        $("#step3").html("<span class='answer'>I don't want to check this</span>");
        $("#whattodo").html("OK, you can still block this ad for yourself on the Options page.  Thanks!");
      });
    </script>
    
    <div id="whattodo"></div>
    
    <!--GENERAL STUFF-->
    <script type="text/javascript">
      //clicking a radiobutton label triggers the radiobutton
      $(".optionDescription").click(checkboxlabel_clicked);
      
      //check for updates
      var AdBlockVersion;
      try {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", chrome.extension.getURL('manifest.json'), false);
        xhr.onreadystatechange = function() {
          if(this.readyState == 4) {
            //get the current version
            AdBlockVersion = JSON.parse(this.responseText).version;
            //check for newer versions
            var xhr2 = new XMLHttpRequest();
            var checkURL = "http://clients2.google.com/service/update2/crx?" +
                "x=id%3Dgighmmpiobklfepjocnamgkkbiglidom%26v%3D" +
                AdBlockVersion + "%26uc";
            if (SAFARI) 
              checkURL = "http://safariadblock.com/update.plist";
            //fetch the version check file
            xhr2.open("GET", checkURL, false);
            xhr2.onreadystatechange = function() {
              if(this.readyState == 4) {
                var updateURL;
                if (!SAFARI) {
                  var usefultext = this.responseText.match(/\<updatecheck.+status\=\".*\"\/\>/)[0];
                  if (!usefultext) return;
                  var status = usefultext.match(/status\=\"[^\"]*\"/)[0]
                  status = status.replace('status="', '').replace('"','');
                  if (status == "ok") {
                    updateURL = usefultext.match(/codebase\=\"[^\"]*\"/)[0]
                    updateURL = updateURL.replace('codebase="', '')
                    updateURL = updateURL.replace('"','');
                  }
                } else {
                  var version = this.responseText.match(/\<string\>\d+\.\d+\.\d+\<\/string\>/)[0]
                  version = version.replace(/\<[^\<]+\>/g,'');
                  if (version != AdBlockVersion) {
                    updateURL = this.responseText.match(/http\:\/\/.*\.safariextz/)[0];
                  }
                }
                //new version available
                if (updateURL) {
                  $("#whattodo").html(
                      "You are using an old version of AdBlock. Please" +
                      " first <a href='" + updateURL + "'>update</a> to the newest version of AdBlock");
                  $("div[id^='step'][id$='DIV']").css('display', 'none');
                }
              }
            };
            xhr2.send();
          }
        };
        xhr.send();
      } catch (ex) {}
    </script>
  </body>
</html>
